<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase CRUD - ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ Avatar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 flex flex-wrap gap-4 justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Firebase CRUD Manager</h1>
            <div class="flex gap-2">
                <button onclick="refreshAllData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>

        <!-- Collection Tabs -->
        <div class="mb-4 border-b border-gray-200 overflow-x-auto">
            <ul class="flex flex-nowrap -mb-px text-sm font-medium text-center" id="collectionTabs"></ul>
        </div>

        <!-- Table Container -->
        <div id="tableContainer" class="space-y-6"></div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-[32rem] shadow-lg rounded-lg bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <button onclick="closeModal()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="dataForm" onsubmit="saveData(event)">
                    <input type="hidden" id="modalCollection">
                    <input type="hidden" id="modalKey">
                    
                    <div id="modalFields" class="space-y-4 max-h-96 overflow-y-auto"></div>
                    
                    <!-- Avatar Preview -->
                    <div id="avatarPreviewContainer" class="mb-4 hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                        <div class="flex items-center space-x-4">
                            <img id="avatarPreview" src="" class="h-16 w-16 rounded-full object-cover border-2 border-gray-300" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Error&background=ff4444&color=fff';">
                            <div>
                                <p id="avatarStatus" class="text-sm text-gray-600"></p>
                                <button type="button" onclick="testImageUrl()" class="text-xs text-blue-600 hover:text-blue-800 mt-1">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end mt-6">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                    <h3 class="text-lg font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <p class="mb-4 text-gray-600" id="deleteMessage"></p>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
                </div>
            </div>
        </div>

        <!-- Image Preview Modal -->
        <div id="imageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-auto max-w-2xl shadow-lg rounded-lg bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</h3>
                    <button onclick="closeImageModal()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex justify-center">
                    <img id="largeImage" src="" class="max-w-full max-h-[70vh] object-contain" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Error&background=ff4444&color=fff';">
                </div>
                <p id="imageUrl" class="text-sm text-gray-500 mt-4 break-all"></p>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg hidden transition-all duration-500 z-50">
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxQr1PCwjWhoz143Ipzcjx9sq2hw5R9dc",
            authDomain: "cm-bookingroom.firebaseapp.com",
            databaseURL: "https://cm-bookingroom-default-rtdb.firebaseio.com",
            projectId: "cm-bookingroom",
            storageBucket: "cm-bookingroom.firebasestorage.app",
            messagingSenderId: "312076484549",
            appId: "1:312076484549:web:d9e1cb3e28747c1aa695ac"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("‚úÖ Firebase initialized");
        } catch (error) {
            console.error("‚ùå Firebase init error:", error);
        }

        const database = firebase.database();
        
        // State
        let allData = {};
        let collections = [];
        let currentDelete = { collection: null, key: null };
        let currentImageUrl = '';

        // Load all data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        function loadAllData() {
            showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", "info");
            
            database.ref().once('value', (snapshot) => {
                allData = snapshot.val() || {};
                collections = Object.keys(allData);
                
                console.log("üì¶ All collections:", collections);
                console.log("üìä Data:", allData);
                
                renderTabs();
                renderAllTables();
                
                showToast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
            }, (error) => {
                console.error("‚ùå Error:", error);
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message, "error");
            });
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('collectionTabs');
            
            if (collections.length === 0) {
                tabsContainer.innerHTML = '<li class="text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
                return;
            }
            
            let tabsHtml = '';
            collections.forEach((collection, index) => {
                const count = allData[collection] ? Object.keys(allData[collection]).length : 0;
                tabsHtml += `
                    <li class="mr-2">
                        <button onclick="showCollection('${collection}')" 
                            class="inline-block p-4 border-b-2 ${index === 0 ? 'border-blue-600 text-blue-600' : 'border-transparent hover:text-gray-600 hover:border-gray-300'}"
                            id="tab-${collection}">
                            ${collection} <span class="ml-1 text-xs bg-gray-200 px-2 py-0.5 rounded-full">${count}</span>
                        </button>
                    </li>
                `;
            });
            
            tabsContainer.innerHTML = tabsHtml;
        }

        function renderAllTables() {
            const container = document.getElementById('tableContainer');
            
            if (collections.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <i class="fas fa-database text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <button onclick="openAddModal()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            collections.forEach(collection => {
                html += createTableForCollection(collection);
            });
            
            container.innerHTML = html;
            
            // Show first collection by default
            if (collections.length > 0) {
                showCollection(collections[0]);
            }
        }

        function createTableForCollection(collection) {
            const data = allData[collection] || {};
            const keys = Object.keys(data);
            
            if (keys.length === 0) {
                return `
                    <div id="table-${collection}" class="collection-table hidden mb-6">
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="bg-gray-50 px-6 py-3 border-b flex justify-between items-center">
                                <h2 class="font-bold text-gray-800 text-lg">${collection}</h2>
                                <button onclick="openAddModal('${collection}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                            <div class="p-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô ${collection}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Get all possible fields
            const allFields = new Set();
            keys.forEach(key => {
                Object.keys(data[key] || {}).forEach(field => allFields.add(field));
            });
            
            const fields = ['key', ...Array.from(allFields)];
            
            // Generate headers
            const headers = fields.map(field => {
                let displayName = field;
                if (field === 'key') displayName = 'ID/Key';
                else if (field === 'name' || field === 'displayName') displayName = '‡∏ä‡∏∑‡πà‡∏≠';
                else if (field === 'email') displayName = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                else if (isAvatarField(field)) displayName = '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                else if (field === 'role') displayName = '‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó';
                else if (field === 'status') displayName = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
                else if (field === 'department') displayName = '‡πÅ‡∏ú‡∏ô‡∏Å';
                else if (field === 'createdAt') displayName = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠';
                else if (field === 'updatedAt') displayName = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
                
                return `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${displayName}</th>`;
            }).join('');
            
            // Generate rows
            const rows = keys.map(key => {
                const item = data[key];
                const rowFields = fields.map(field => {
                    if (field === 'key') {
                        return `<td class="px-6 py-4 whitespace-nowrap font-mono text-xs">${key.substring(0, 8)}...</td>`;
                    }
                    
                    const value = item[field];
                    
                    // Handle avatar/image fields
                    if (isAvatarField(field) && value) {
                        return `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative group">
                                    <img src="${value}" 
                                        class="h-10 w-10 rounded-full object-cover cursor-pointer border-2 border-gray-200 hover:border-blue-500 transition-all"
                                        onclick="showLargeImage('${value}', '${item.name || item.displayName || 'Avatar'}')"
                                        onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(item.name || item.displayName || '?')}&background=random&color=fff&bold=true';">
                                    <div class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="event.stopPropagation(); showLargeImage('${value}', '${item.name || item.displayName || 'Avatar'}')">
                                        <i class="fas fa-search-plus text-xs"></i>
                                    </div>
                                </div>
                            </td>
                        `;
                    }
                    
                    // Handle status
                    if (field === 'status') {
                        const statusClass = value === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        return `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${value || 'inactive'}</span>
                            </td>
                        `;
                    }
                    
                    // Handle role
                    if (field === 'role') {
                        const roleClass = value === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800';
                        return `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full ${roleClass}">${value || 'user'}</span>
                            </td>
                        `;
                    }
                    
                    // Handle dates
                    if (field === 'createdAt' || field === 'updatedAt') {
                        const date = value ? new Date(value).toLocaleString('th-TH') : '-';
                        return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>`;
                    }
                    
                    // Default display
                    return `<td class="px-6 py-4 whitespace-nowrap">${value || '-'}</td>`;
                }).join('');
                
                return `
                    <tr class="hover:bg-gray-50">
                        ${rowFields}
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="openEditModal('${collection}', '${key}')" class="text-blue-600 hover:text-blue-900 mr-3" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="openDeleteModal('${collection}', '${key}')" class="text-red-600 hover:text-red-900" title="‡∏•‡∏ö">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            return `
                <div id="table-${collection}" class="collection-table hidden mb-6">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b flex justify-between items-center">
                            <h2 class="font-bold text-gray-800 text-lg">${collection} <span class="ml-2 text-sm font-normal text-gray-500">(${keys.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span></h2>
                            <button onclick="openAddModal('${collection}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        ${headers}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to check if field is an avatar/image field
        function isAvatarField(field) {
            const avatarFields = ['avatar', 'avatarUrl', 'photo', 'photoURL', 'photoUrl', 'picture', 'image', 'profileImage', 'profilePic', 'imageUrl'];
            return avatarFields.some(af => field.toLowerCase().includes(af.toLowerCase()));
        }

        function showLargeImage(url, title) {
            currentImageUrl = url;
            document.getElementById('largeImage').src = url;
            document.getElementById('imageUrl').textContent = url;
            document.getElementById('imageModal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        function showCollection(collection) {
            document.querySelectorAll('.collection-table').forEach(el => {
                el.classList.add('hidden');
            });
            
            const selectedTable = document.getElementById(`table-${collection}`);
            if (selectedTable) {
                selectedTable.classList.remove('hidden');
            }
            
            collections.forEach(c => {
                const tab = document.getElementById(`tab-${c}`);
                if (tab) {
                    if (c === collection) {
                        tab.classList.add('border-blue-600', 'text-blue-600');
                        tab.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        tab.classList.remove('border-blue-600', 'text-blue-600');
                        tab.classList.add('border-transparent', 'text-gray-500');
                    }
                }
            });
        }

        function openAddModal(collection = null) {
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('modalCollection').value = collection || (collections.length > 0 ? collections[0] : '');
            document.getElementById('modalKey').value = '';
            
            generateModalFields();
            document.getElementById('modal').classList.remove('hidden');
        }

        function openEditModal(collection, key) {
            const item = allData[collection]?.[key];
            if (!item) return;
            
            document.getElementById('modalTitle').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô ${collection}`;
            document.getElementById('modalCollection').value = collection;
            document.getElementById('modalKey').value = key;
            
            generateModalFields(item);
            document.getElementById('modal').classList.remove('hidden');
        }

        function generateModalFields(existingData = {}) {
            const container = document.getElementById('modalFields');
            const collection = document.getElementById('modalCollection').value;
            const isEdit = Object.keys(existingData).length > 0;
            
            let fields = [];
            if (isEdit) {
                fields = Object.keys(existingData);
            } else {
                // Default fields for new records
                if (collection === 'Users' || collection === 'users') {
                    fields = ['name', 'email', 'department', 'status', 'role', 'avatarUrl'];
                } else {
                    fields = ['name', 'value', 'description'];
                }
            }
            
            let html = '';
            
            fields.forEach(field => {
                const value = existingData[field] || '';
                let inputType = 'text';
                
                if (field.includes('email')) inputType = 'email';
                else if (isAvatarField(field)) inputType = 'url';
                else if (field.includes('date')) inputType = 'datetime-local';
                
                let inputHtml = '';
                
                if (field === 'status') {
                    inputHtml = `
                        <select name="${field}" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="checkAvatarField(this)">
                            <option value="active" ${value === 'active' ? 'selected' : ''}>Active</option>
                            <option value="inactive" ${value === 'inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    `;
                } else if (field === 'role') {
                    inputHtml = `
                        <select name="${field}" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="checkAvatarField(this)">
                            <option value="user" ${value === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${value === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    `;
                } else if (field === 'department') {
                    inputHtml = `
                        <select name="${field}" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="checkAvatarField(this)">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                            <option value="IT" ${value === 'IT' ? 'selected' : ''}>IT</option>
                            <option value="HR" ${value === 'HR' ? 'selected' : ''}>HR</option>
                            <option value="Sales" ${value === 'Sales' ? 'selected' : ''}>Sales</option>
                            <option value="Marketing" ${value === 'Marketing' ? 'selected' : ''}>Marketing</option>
                        </select>
                    `;
                } else {
                    inputHtml = `
                        <input type="${inputType}" 
                            name="${field}" 
                            value="${value}" 
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onchange="checkAvatarField(this)"
                            onkeyup="checkAvatarField(this)">
                    `;
                }
                
                let displayName = field;
                if (isAvatarField(field)) displayName = '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û URL';
                else if (field === 'createdAt') displayName = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á';
                else if (field === 'updatedAt') displayName = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
                else displayName = field.charAt(0).toUpperCase() + field.slice(1);
                
                html += `
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">${displayName}</label>
                        ${inputHtml}
                        ${isAvatarField(field) ? `
                            <div class="mt-1 flex items-center">
                                <span class="text-xs text-gray-500">üîó ‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                                <button type="button" onclick="testSpecificUrl('${field}')" class="ml-2 text-xs text-blue-600 hover:text-blue-800">
                                    ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Add JSON field
            html += `
                <div class="mb-4 border-t pt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö JSON</label>
                    <textarea id="jsonInput" rows="4" class="w-full px-3 py-2 border rounded-lg font-mono text-sm" 
                        placeholder='{"field": "value"}'></textarea>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Show avatar preview if there are avatar fields
            const avatarField = fields.find(f => isAvatarField(f));
            if (avatarField && existingData[avatarField]) {
                showAvatarPreview(existingData[avatarField]);
            }
        }

        function checkAvatarField(element) {
            if (isAvatarField(element.name)) {
                showAvatarPreview(element.value);
            }
        }

        function showAvatarPreview(url) {
            if (!url) {
                document.getElementById('avatarPreviewContainer').classList.add('hidden');
                return;
            }
            
            const preview = document.getElementById('avatarPreview');
            const status = document.getElementById('avatarStatus');
            
            preview.src = url;
            status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå...';
            document.getElementById('avatarPreviewContainer').classList.remove('hidden');
            
            // Test if image loads
            const img = new Image();
            img.onload = function() {
                status.innerHTML = '<span class="text-green-600">‚úÖ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span>';
            };
            img.onerror = function() {
                status.innerHTML = '<span class="text-red-600">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</span>';
                preview.src = 'https://ui-avatars.com/api/?name=Error&background=ff4444&color=fff';
            };
            img.src = url;
        }

        function testSpecificUrl(fieldName) {
            const input = document.querySelector(`[name="${fieldName}"]`);
            if (input && input.value) {
                showAvatarPreview(input.value);
            } else {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            }
        }

        function testImageUrl() {
            const avatarInputs = document.querySelectorAll('input[type="url"]');
            for (let input of avatarInputs) {
                if (isAvatarField(input.name) && input.value) {
                    showAvatarPreview(input.value);
                    break;
                }
            }
        }

        function saveData(event) {
            event.preventDefault();
            
            const collection = document.getElementById('modalCollection').value;
            const key = document.getElementById('modalKey').value;
            const jsonInput = document.getElementById('jsonInput').value;
            
            let data = {};
            
            if (jsonInput.trim()) {
                try {
                    data = JSON.parse(jsonInput);
                } catch (e) {
                    showToast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }
            } else {
                const formData = new FormData(event.target);
                for (let [field, value] of formData.entries()) {
                    if (field !== 'jsonInput') {
                        data[field] = value;
                    }
                }
            }
            
            const now = new Date().toISOString();
            if (key) {
                data.updatedAt = now;
            } else {
                data.createdAt = now;
                data.updatedAt = now;
            }
            
            const ref = database.ref(collection);
            
            if (key) {
                ref.child(key).update(data)
                    .then(() => {
                        closeModal();
                        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        loadAllData();
                    })
                    .catch(error => {
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                    });
            } else {
                ref.push(data)
                    .then(() => {
                        closeModal();
                        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        loadAllData();
                    })
                    .catch(error => {
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                    });
            }
        }

        function openDeleteModal(collection, key) {
            currentDelete = { collection, key };
            document.getElementById('deleteMessage').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô ${collection}?`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            currentDelete = { collection: null, key: null };
            document.getElementById('deleteModal').classList.add('hidden');
        }

        function confirmDelete() {
            if (!currentDelete.collection || !currentDelete.key) return;
            
            database.ref(`${currentDelete.collection}/${currentDelete.key}`).remove()
                .then(() => {
                    closeDeleteModal();
                    showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    loadAllData();
                })
                .catch(error => {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                    closeDeleteModal();
                });
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('avatarPreviewContainer').classList.add('hidden');
        }

        function refreshAllData() {
            loadAllData();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-blue-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';
            
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg`;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            const deleteModal = document.getElementById('deleteModal');
            const imageModal = document.getElementById('imageModal');
            
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
            if (event.target === imageModal) {
                closeImageModal();
            }
        }
    </script>
</body>
</html>
