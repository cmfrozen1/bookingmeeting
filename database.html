<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase DB Manager Â· Dark Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap');
        
        * {
            font-family: 'JetBrains Mono', monospace;
        }
        
        body {
            background-color: #0a0c0f;
            background-image: 
                radial-gradient(circle at 25% 0%, rgba(0, 255, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 100%, rgba(255, 0, 255, 0.03) 0%, transparent 50%);
        }
        
        .db-panel {
            background: #14171c;
            border: 1px solid #2a2f35;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        
        .db-header {
            background: #1a1e24;
            border-bottom: 1px solid #2a2f35;
            color: #e0e4e9;
        }
        
        .db-table {
            background: #14171c;
            border: 1px solid #2a2f35;
        }
        
        .db-table th {
            background: #1e2329;
            color: #00e5ff;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
            border-bottom: 2px solid #00e5ff;
        }
        
        .db-table td {
            color: #b0b7c2;
            border-bottom: 1px solid #252b32;
        }
        
        .db-table tr:hover {
            background: #1f262e;
        }
        
        .db-tab {
            color: #8f9aa8;
            border-bottom: 2px solid transparent;
        }
        
        .db-tab:hover {
            color: #00e5ff;
            border-bottom-color: #00e5ff;
        }
        
        .db-tab.active {
            color: #00e5ff;
            border-bottom-color: #00e5ff;
            font-weight: 500;
        }
        
        .db-button {
            background: #1e262f;
            border: 1px solid #2f3843;
            color: #e0e4e9;
            transition: all 0.2s;
        }
        
        .db-button:hover {
            background: #2a3440;
            border-color: #00e5ff;
            color: #00e5ff;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }
        
        .db-button-primary {
            background: #005f73;
            border: 1px solid #0a9396;
            color: #e0e4e9;
        }
        
        .db-button-primary:hover {
            background: #0a9396;
            border-color: #00e5ff;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.5);
        }
        
        .db-button-export {
            background: #2d1b3c;
            border: 1px solid #9d4edd;
            color: #e0e4e9;
        }
        
        .db-button-export:hover {
            background: #4a2b63;
            border-color: #c77dff;
            color: #c77dff;
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.5);
        }
        
        .db-input {
            background: #1a1e24;
            border: 1px solid #2f3843;
            color: #e0e4e9;
            border-radius: 6px;
        }
        
        .db-input:focus {
            border-color: #00e5ff;
            box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.2);
            outline: none;
        }
        
        .db-badge {
            background: #1e2a36;
            color: #7aa2f7;
            border: 1px solid #2f3b4a;
        }
        
        .db-status-active {
            background: rgba(0, 255, 128, 0.15);
            color: #00ffa0;
            border: 1px solid #00ffa0;
        }
        
        .db-status-inactive {
            background: rgba(255, 80, 80, 0.15);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .db-role-admin {
            background: rgba(255, 200, 0, 0.15);
            color: #ffd700;
            border: 1px solid #ffd700;
        }
        
        .db-role-user {
            background: rgba(100, 100, 255, 0.15);
            color: #7aa2f7;
            border: 1px solid #7aa2f7;
        }
        
        .db-modal {
            background: #1a1e24;
            border: 1px solid #2f3843;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
        }
        
        .db-toast {
            background: #1e262f;
            border: 1px solid #00e5ff;
            color: #e0e4e9;
            backdrop-filter: blur(10px);
        }
        
        .db-count-badge {
            background: #1e2a36;
            color: #7aa2f7;
            border: 1px solid #2f3b4a;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
        }
        
        .db-dropdown {
            background: #1a1e24;
            border: 1px solid #2f3843;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .db-dropdown-item {
            color: #b0b7c2;
            transition: all 0.2s;
        }
        
        .db-dropdown-item:hover {
            background: #252e3a;
            color: #00e5ff;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #14171c;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2f3843;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00e5ff;
        }
        
        /* Glowing text */
        .glow-text {
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
        }
        
        /* Database grid background */
        .db-grid {
            background-image: 
                linear-gradient(rgba(0, 229, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Export animation */
        @keyframes exportPulse {
            0% { box-shadow: 0 0 0 0 rgba(157, 78, 221, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(157, 78, 221, 0); }
            100% { box-shadow: 0 0 0 0 rgba(157, 78, 221, 0); }
        }
        
        .export-pulse {
            animation: exportPulse 2s infinite;
        }
    </style>
</head>
<body class="p-6 min-h-screen db-grid">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 flex flex-wrap gap-4 justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 glow-text">
                    FIREBASE DB MANAGER
                </h1>
                <p class="text-cyan-600 text-sm mt-1">Real-time Database Â· CRUD Operations</p>
            </div>
            <div class="flex gap-3">
                <!-- Export Dropdown -->
                <div class="relative" id="exportDropdown">
                    <button onclick="toggleExportMenu()" class="db-button-export px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                        <i class="fas fa-download"></i>
                        <span>EXPORT</span>
                        <i class="fas fa-chevron-down text-xs ml-1"></i>
                    </button>
                    <div id="exportMenu" class="absolute right-0 mt-2 w-48 db-dropdown rounded-lg overflow-hidden hidden z-50">
                        <div class="py-1">
                            <button onclick="exportAllData()" class="db-dropdown-item w-full text-left px-4 py-2 text-sm flex items-center gap-2">
                                <i class="fas fa-database w-4"></i>
                                <span>All Collections</span>
                            </button>
                            <button onclick="exportCurrentCollection()" class="db-dropdown-item w-full text-left px-4 py-2 text-sm flex items-center gap-2">
                                <i class="fas fa-table w-4"></i>
                                <span>Current Collection</span>
                            </button>
                            <div class="border-t border-[#2f3843] my-1"></div>
                            <button onclick="showBackupHistory()" class="db-dropdown-item w-full text-left px-4 py-2 text-sm flex items-center gap-2">
                                <i class="fas fa-history w-4"></i>
                                <span>Backup History</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button onclick="refreshAllData()" class="db-button px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                    <i class="fas fa-sync-alt text-cyan-400"></i>
                    <span>REFRESH</span>
                </button>
                <button onclick="openAddModal()" class="db-button-primary px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                    <i class="fas fa-plus"></i>
                    <span>NEW RECORD</span>
                </button>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="mb-4 p-3 rounded-lg hidden text-sm"></div>

        <!-- Collection Tabs -->
        <div class="db-panel mb-4">
            <div class="px-4 py-2 border-b border-[#2a2f35] flex items-center gap-2">
                <i class="fas fa-database text-cyan-400 text-sm"></i>
                <span class="text-gray-400 text-xs">COLLECTIONS</span>
            </div>
            <div class="overflow-x-auto p-2">
                <ul class="flex space-x-4 text-sm" id="collectionTabs"></ul>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="statsContainer"></div>

        <!-- Table Container -->
        <div id="tableContainer" class="space-y-6"></div>

        <!-- Export Preview Modal -->
        <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-80 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 border w-[48rem] shadow-2xl rounded-xl db-modal">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-purple-400">
                        <i class="fas fa-file-export mr-2"></i>EXPORT PREVIEW
                    </h3>
                    <button onclick="closeExportModal()" class="text-gray-500 hover:text-purple-400 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <span class="text-xs text-gray-500">DATA SIZE:</span>
                        <span id="exportSize" class="ml-2 text-cyan-400 text-sm"></span>
                    </div>
                    <div>
                        <span class="text-xs text-gray-500">RECORDS:</span>
                        <span id="exportCount" class="ml-2 text-cyan-400 text-sm"></span>
                    </div>
                </div>
                
                <div class="db-panel p-4 max-h-96 overflow-auto">
                    <pre id="exportPreview" class="text-xs text-gray-300 font-mono"></pre>
                </div>
                
                <div class="flex gap-3 justify-end mt-6 border-t border-[#2a2f35] pt-4">
                    <div class="flex-1">
                        <input type="text" id="exportFilename" class="db-input px-3 py-2 text-sm font-mono w-full" placeholder="filename.json" value="firebase-backup">
                    </div>
                    <button type="button" onclick="closeExportModal()" class="db-button px-4 py-2 rounded-lg text-sm">
                        CANCEL
                    </button>
                    <button onclick="downloadExport()" class="db-button-export px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-download"></i>
                        DOWNLOAD
                    </button>
                </div>
            </div>
        </div>

        <!-- Backup History Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-80 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 border w-[40rem] shadow-2xl rounded-xl db-modal">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-purple-400">
                        <i class="fas fa-history mr-2"></i>BACKUP HISTORY
                    </h3>
                    <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-purple-400 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="backupList" class="space-y-2 max-h-96 overflow-auto">
                    <!-- Backup items will be added here -->
                </div>
                
                <div class="flex justify-end mt-6 border-t border-[#2a2f35] pt-4">
                    <button onclick="clearBackupHistory()" class="db-button px-4 py-2 rounded-lg text-sm text-red-400">
                        CLEAR HISTORY
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 border w-[32rem] shadow-2xl rounded-xl db-modal">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-cyan-400" id="modalTitle">
                        <i class="fas fa-database mr-2"></i>NEW RECORD
                    </h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-cyan-400 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="dataForm" onsubmit="saveData(event)">
                    <input type="hidden" id="modalCollection">
                    <input type="hidden" id="modalKey">
                    
                    <div id="modalFields" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                    
                    <!-- Avatar Preview -->
                    <div id="avatarPreviewContainer" class="mb-4 hidden p-4 db-panel">
                        <label class="block text-cyan-400 text-xs font-bold mb-3">PREVIEW</label>
                        <div class="flex items-center space-x-4">
                            <img id="avatarPreview" src="" class="h-16 w-16 rounded-full object-cover border-2 border-cyan-400/30">
                            <div>
                                <p id="avatarStatus" class="text-xs text-gray-400"></p>
                                <button type="button" onclick="testImageUrl()" class="text-xs text-cyan-400 hover:text-cyan-300 mt-2">
                                    <i class="fas fa-sync-alt mr-1"></i>TEST URL
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 justify-end mt-6 border-t border-[#2a2f35] pt-4">
                        <button type="button" onclick="closeModal()" class="db-button px-4 py-2 rounded-lg text-sm">
                            CANCEL
                        </button>
                        <button type="submit" class="db-button-primary px-6 py-2 rounded-lg text-sm font-bold">
                            SAVE
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-80 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 border w-96 shadow-2xl rounded-xl db-modal">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4" style="color: #ff6b6b;"></i>
                    <h3 class="text-lg font-bold text-red-400 mb-4">CONFIRM DELETE</h3>
                    <p class="mb-6 text-gray-400 text-sm" id="deleteMessage"></p>
                </div>
                <div class="flex gap-3 justify-end">
                    <button onclick="closeDeleteModal()" class="db-button px-4 py-2 rounded-lg text-sm">
                        CANCEL
                    </button>
                    <button onclick="confirmDelete()" class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500 rounded-lg hover:bg-red-500/30 transition text-sm font-bold">
                        DELETE
                    </button>
                </div>
            </div>
        </div>

        <!-- Image Preview Modal -->
        <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 border w-auto max-w-3xl shadow-2xl rounded-xl db-modal">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-cyan-400">IMAGE PREVIEW</h3>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-cyan-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex justify-center">
                    <img id="largeImage" src="" class="max-w-full max-h-[70vh] object-contain rounded-lg border border-[#2a2f35]">
                </div>
                <p id="imageUrl" class="text-xs text-gray-500 mt-4 break-all font-mono"></p>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg hidden transition-all duration-500 z-50 db-toast">
            <span id="toastMessage" class="text-sm"></span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxQr1PCwjWhoz143Ipzcjx9sq2hw5R9dc",
            authDomain: "cm-bookingroom.firebaseapp.com",
            databaseURL: "https://cm-bookingroom-default-rtdb.firebaseio.com",
            projectId: "cm-bookingroom",
            storageBucket: "cm-bookingroom.firebasestorage.app",
            messagingSenderId: "312076484549",
            appId: "1:312076484549:web:d9e1cb3e28747c1aa695ac"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("âœ… Firebase initialized");
        } catch (error) {
            console.error("âŒ Firebase init error:", error);
        }

        const database = firebase.database();
        
        // State
        let allData = {};
        let collections = [];
        let currentDelete = { collection: null, key: null };
        let currentImageUrl = '';
        let currentCollection = null;
        let exportData = null;
        let backupHistory = JSON.parse(localStorage.getItem('firebaseBackupHistory') || '[]');

        // Check connection
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                showConnectionStatus("success", "CONNECTED TO FIREBASE");
                loadAllData();
            } else {
                showConnectionStatus("error", "DISCONNECTED");
            }
        });

        function showConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.classList.remove('hidden');
            
            if (type === "success") {
                statusDiv.className = 'mb-4 p-3 rounded-lg text-sm bg-green-500/10 border border-green-500 text-green-400';
            } else {
                statusDiv.className = 'mb-4 p-3 rounded-lg text-sm bg-red-500/10 border border-red-500 text-red-400';
            }
            
            statusDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>${message}`;
            
            if (type === "success") {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 3000);
            }
        }

        function loadAllData() {
            showToast("LOADING DATA...", "info");
            
            database.ref().once('value', (snapshot) => {
                allData = snapshot.val() || {};
                collections = Object.keys(allData);
                
                console.log("ðŸ“¦ Collections:", collections);
                console.log("ðŸ“Š Data:", allData);
                
                renderTabs();
                renderStats();
                renderAllTables();
                
                showToast("DATA LOADED", "success");
            }, (error) => {
                console.error("âŒ Error:", error);
                showToast("ERROR: " + error.message, "error");
            });
        }

        function renderStats() {
            const container = document.getElementById('statsContainer');
            let html = '';
            
            collections.slice(0, 4).forEach(collection => {
                const count = allData[collection] ? Object.keys(allData[collection]).length : 0;
                html += `
                    <div class="db-panel p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">${collection}</p>
                                <p class="text-2xl font-bold text-cyan-400">${count}</p>
                            </div>
                            <div class="text-3xl opacity-30">
                                <i class="fas ${getCollectionIcon(collection)}"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getCollectionIcon(collection) {
            if (collection === 'Users' || collection === 'users') return 'fa-users';
            if (collection === 'Settings') return 'fa-cog';
            return 'fa-folder';
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('collectionTabs');
            
            if (collections.length === 0) {
                tabsContainer.innerHTML = '<li class="text-gray-600 p-4 text-sm">NO COLLECTIONS FOUND</li>';
                return;
            }
            
            let tabsHtml = '';
            collections.forEach((collection, index) => {
                const count = allData[collection] ? Object.keys(allData[collection]).length : 0;
                tabsHtml += `
                    <li>
                        <button onclick="showCollection('${collection}')" 
                            class="db-tab px-4 py-2 text-sm font-mono ${index === 0 ? 'active' : ''}"
                            id="tab-${collection}">
                            <i class="fas ${getCollectionIcon(collection)} mr-2"></i>
                            ${collection}
                            <span class="db-count-badge ml-2">${count}</span>
                        </button>
                    </li>
                `;
            });
            
            tabsContainer.innerHTML = tabsHtml;
        }

        function renderAllTables() {
            const container = document.getElementById('tableContainer');
            
            if (collections.length === 0) {
                container.innerHTML = `
                    <div class="db-panel p-12 text-center">
                        <i class="fas fa-database text-5xl text-gray-700 mb-4"></i>
                        <p class="text-gray-500 text-sm mb-4">NO DATA FOUND IN DATABASE</p>
                        <button onclick="openAddModal()" class="db-button-primary px-6 py-3 rounded-lg text-sm">
                            <i class="fas fa-plus mr-2"></i>CREATE FIRST RECORD
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            collections.forEach(collection => {
                html += createTableForCollection(collection);
            });
            
            container.innerHTML = html;
            
            if (collections.length > 0) {
                showCollection(collections[0]);
            }
        }

        function createTableForCollection(collection) {
            const data = allData[collection] || {};
            const keys = Object.keys(data);
            
            if (keys.length === 0) {
                return `
                    <div id="table-${collection}" class="collection-table hidden mb-6">
                        <div class="db-panel overflow-hidden">
                            <div class="db-header px-6 py-3 flex justify-between items-center">
                                <h2 class="font-bold text-cyan-400">
                                    <i class="fas ${getCollectionIcon(collection)} mr-2"></i>${collection}
                                </h2>
                                <button onclick="openAddModal('${collection}')" class="db-button px-3 py-1 rounded text-xs">
                                    <i class="fas fa-plus mr-1"></i>ADD
                                </button>
                            </div>
                            <div class="p-12 text-center">
                                <i class="fas fa-inbox text-3xl text-gray-700 mb-2"></i>
                                <p class="text-gray-600 text-sm">EMPTY COLLECTION</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const allFields = new Set();
            keys.forEach(key => {
                Object.keys(data[key] || {}).forEach(field => allFields.add(field));
            });
            
            const fields = ['key', ...Array.from(allFields)];
            
            const headers = fields.map(field => {
                let displayName = field.toUpperCase();
                if (field === 'key') displayName = 'ID';
                else if (isAvatarField(field)) displayName = 'AVATAR';
                else if (field === 'createdAt') displayName = 'CREATED';
                else if (field === 'updatedAt') displayName = 'UPDATED';
                
                return `<th class="px-6 py-3 text-left text-xs font-mono">${displayName}</th>`;
            }).join('');
            
            const rows = keys.map(key => {
                const item = data[key];
                const rowFields = fields.map(field => {
                    if (field === 'key') {
                        return `<td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-cyan-400/70">${key.substring(0, 8)}...</td>`;
                    }
                    
                    const value = item[field];
                    
                    if (isAvatarField(field) && value) {
                        return `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative group">
                                    <img src="${value}" 
                                        class="h-8 w-8 rounded-full object-cover cursor-pointer border border-cyan-400/30 hover:border-cyan-400 transition-all"
                                        onclick="showLargeImage('${value}')"
                                        onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(item.name || item.displayName || '?')}&background=0A9396&color=fff&bold=true';">
                                </div>
                            </td>
                        `;
                    }
                    
                    if (field === 'status') {
                        return `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full ${value === 'active' ? 'db-status-active' : 'db-status-inactive'}">
                                    ${(value || 'inactive').toUpperCase()}
                                </span>
                            </td>
                        `;
                    }
                    
                    if (field === 'role') {
                        return `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full ${value === 'admin' ? 'db-role-admin' : 'db-role-user'}">
                                    ${(value || 'user').toUpperCase()}
                                </span>
                            </td>
                        `;
                    }
                    
                    if (field === 'createdAt' || field === 'updatedAt') {
                        const date = value ? new Date(value).toLocaleString('th-TH') : '-';
                        return `<td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${date}</td>`;
                    }
                    
                    if (field === 'email') {
                        return `<td class="px-6 py-4 whitespace-nowrap text-xs text-cyan-400/70">${value || '-'}</td>`;
                    }
                    
                    return `<td class="px-6 py-4 whitespace-nowrap text-sm">${value || '-'}</td>`;
                }).join('');
                
                return `
                    <tr class="hover:bg-[#1f262e] transition-colors cursor-pointer" onclick="openEditModal('${collection}', '${key}')">
                        ${rowFields}
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="event.stopPropagation(); openDeleteModal('${collection}', '${key}')" 
                                class="text-red-500/50 hover:text-red-400 transition-colors" title="DELETE">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            return `
                <div id="table-${collection}" class="collection-table hidden mb-6">
                    <div class="db-panel overflow-hidden">
                        <div class="db-header px-6 py-3 flex justify-between items-center">
                            <h2 class="font-bold text-cyan-400">
                                <i class="fas ${getCollectionIcon(collection)} mr-2"></i>${collection}
                                <span class="ml-3 text-xs font-normal text-gray-500">${keys.length} RECORDS</span>
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); exportCollection('${collection}')" class="db-button-export px-3 py-1 rounded text-xs flex items-center gap-1">
                                    <i class="fas fa-download"></i>
                                    <span>EXPORT</span>
                                </button>
                                <button onclick="openAddModal('${collection}')" class="db-button px-3 py-1 rounded text-xs">
                                    <i class="fas fa-plus mr-1"></i>ADD
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="db-table min-w-full divide-y divide-[#2a2f35]">
                                <thead>
                                    <tr>
                                        ${headers}
                                        <th class="px-6 py-3 text-left text-xs font-mono">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function isAvatarField(field) {
            const avatarFields = ['avatar', 'avatarUrl', 'photo', 'photoURL', 'photoUrl', 'picture', 'image', 'profileImage', 'profilePic', 'imageUrl'];
            return avatarFields.some(af => field.toLowerCase().includes(af.toLowerCase()));
        }

        // Export Functions
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
            
            // Close menu when clicking outside
            if (!menu.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeExportMenuOnClickOutside);
                }, 100);
            }
        }

        function closeExportMenuOnClickOutside(event) {
            const dropdown = document.getElementById('exportDropdown');
            const menu = document.getElementById('exportMenu');
            
            if (!dropdown.contains(event.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeExportMenuOnClickOutside);
            }
        }

        function exportAllData() {
            exportData = allData;
            showExportModal('Complete Database Backup', allData);
            addToBackupHistory('full', new Date().toISOString(), Object.keys(allData).length);
        }

        function exportCurrentCollection() {
            if (!currentCollection) {
                showToast('NO COLLECTION SELECTED', 'error');
                return;
            }
            
            const collectionData = { [currentCollection]: allData[currentCollection] };
            exportData = collectionData;
            showExportModal(`Collection: ${currentCollection}`, collectionData);
            addToBackupHistory(currentCollection, new Date().toISOString(), 
                allData[currentCollection] ? Object.keys(allData[currentCollection]).length : 0);
        }

        function exportCollection(collection) {
            const collectionData = { [collection]: allData[collection] };
            exportData = collectionData;
            showExportModal(`Collection: ${collection}`, collectionData);
            addToBackupHistory(collection, new Date().toISOString(), 
                allData[collection] ? Object.keys(allData[collection]).length : 0);
        }

        function showExportModal(title, data) {
            document.getElementById('exportModal').classList.remove('hidden');
            
            // Update preview
            const jsonString = JSON.stringify(data, null, 2);
            document.getElementById('exportPreview').textContent = jsonString;
            
            // Calculate size
            const size = new Blob([jsonString]).size;
            const sizeText = size < 1024 ? `${size} B` : 
                            size < 1048576 ? `${(size / 1024).toFixed(2)} KB` : 
                            `${(size / 1048576).toFixed(2)} MB`;
            document.getElementById('exportSize').textContent = sizeText;
            
            // Count records
            let recordCount = 0;
            Object.keys(data).forEach(collection => {
                recordCount += Object.keys(data[collection] || {}).length;
            });
            document.getElementById('exportCount').textContent = recordCount;
            
            // Set filename
            const date = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            document.getElementById('exportFilename').value = `firebase-${title.toLowerCase().replace(/\s+/g, '-')}-${date}`;
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
            exportData = null;
        }

        function downloadExport() {
            if (!exportData) return;
            
            const filename = document.getElementById('exportFilename').value || 'firebase-backup';
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            closeExportModal();
            showToast('EXPORT COMPLETED', 'success');
        }

        // Backup History Functions
        function addToBackupHistory(type, timestamp, count) {
            const backup = {
                id: Date.now(),
                type: type,
                timestamp: timestamp,
                count: count,
                filename: `firebase-${type}-${new Date(timestamp).toISOString().slice(0,19).replace(/:/g,'-')}.json`
            };
            
            backupHistory.unshift(backup);
            if (backupHistory.length > 20) backupHistory.pop(); // Keep last 20 backups
            
            localStorage.setItem('firebaseBackupHistory', JSON.stringify(backupHistory));
        }

        function showBackupHistory() {
            const list = document.getElementById('backupList');
            
            if (backupHistory.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">NO BACKUP HISTORY</p>';
            } else {
                list.innerHTML = backupHistory.map(backup => `
                    <div class="db-panel p-3 flex justify-between items-center">
                        <div>
                            <p class="text-sm text-cyan-400">${backup.type}</p>
                            <p class="text-xs text-gray-500">${new Date(backup.timestamp).toLocaleString('th-TH')}</p>
                            <p class="text-xs text-gray-600">${backup.count} records</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadBackup('${backup.id}')" class="text-cyan-400 hover:text-cyan-300">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="removeBackup('${backup.id}')" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function downloadBackup(id) {
            const backup = backupHistory.find(b => b.id == id);
            if (!backup) return;
            
            // In a real app, you would retrieve the actual backup data
            // For now, we'll just show a message
            showToast('BACKUP DATA WOULD BE DOWNLOADED', 'info');
        }

        function removeBackup(id) {
            backupHistory = backupHistory.filter(b => b.id != id);
            localStorage.setItem('firebaseBackupHistory', JSON.stringify(backupHistory));
            showBackupHistory(); // Refresh
            showToast('BACKUP REMOVED FROM HISTORY', 'info');
        }

        function clearBackupHistory() {
            if (confirm('Clear all backup history?')) {
                backupHistory = [];
                localStorage.removeItem('firebaseBackupHistory');
                closeHistoryModal();
                showToast('HISTORY CLEARED', 'info');
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function showLargeImage(url) {
            currentImageUrl = url;
            document.getElementById('largeImage').src = url;
            document.getElementById('imageUrl').textContent = url;
            document.getElementById('imageModal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        function showCollection(collection) {
            currentCollection = collection;
            
            document.querySelectorAll('.collection-table').forEach(el => {
                el.classList.add('hidden');
            });
            
            const selectedTable = document.getElementById(`table-${collection}`);
            if (selectedTable) {
                selectedTable.classList.remove('hidden');
            }
            
            collections.forEach(c => {
                const tab = document.getElementById(`tab-${c}`);
                if (tab) {
                    if (c === collection) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                }
            });
        }

        function openAddModal(collection = null) {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus mr-2"></i>NEW RECORD';
            document.getElementById('modalCollection').value = collection || (collections.length > 0 ? collections[0] : '');
            document.getElementById('modalKey').value = '';
            
            generateModalFields();
            document.getElementById('modal').classList.remove('hidden');
        }

        function openEditModal(collection, key) {
            const item = allData[collection]?.[key];
            if (!item) return;
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>EDIT RECORD';
            document.getElementById('modalCollection').value = collection;
            document.getElementById('modalKey').value = key;
            
            generateModalFields(item);
            document.getElementById('modal').classList.remove('hidden');
        }

        function generateModalFields(existingData = {}) {
            const container = document.getElementById('modalFields');
            const collection = document.getElementById('modalCollection').value;
            const isEdit = Object.keys(existingData).length > 0;
            
            let fields = [];
            if (isEdit) {
                fields = Object.keys(existingData);
            } else {
                if (collection === 'Users' || collection === 'users') {
                    fields = ['name', 'email', 'department', 'status', 'role', 'avatarUrl'];
                } else {
                    fields = ['name', 'value', 'description'];
                }
            }
            
            let html = '';
            
            if (isEdit) {
                html += `
                    <div class="mb-4 p-3 db-panel">
                        <label class="block text-cyan-400 text-xs mb-1">RECORD KEY</label>
                        <div class="font-mono text-sm text-gray-400">${document.getElementById('modalKey').value}</div>
                    </div>
                `;
            }
            
            fields.forEach(field => {
                const value = existingData[field] || '';
                let inputType = 'text';
                
                if (field.includes('email')) inputType = 'email';
                else if (isAvatarField(field)) inputType = 'url';
                else if (field.includes('date')) inputType = 'datetime-local';
                
                let inputHtml = '';
                
                if (field === 'status') {
                    inputHtml = `
                        <select name="${field}" class="w-full db-input px-3 py-2 text-sm font-mono">
                            <option value="active" ${value === 'active' ? 'selected' : ''}>ACTIVE</option>
                            <option value="inactive" ${value === 'inactive' ? 'selected' : ''}>INACTIVE</option>
                        </select>
                    `;
                } else if (field === 'role') {
                    inputHtml = `
                        <select name="${field}" class="w-full db-input px-3 py-2 text-sm font-mono">
                            <option value="user" ${value === 'user' ? 'selected' : ''}>USER</option>
                            <option value="admin" ${value === 'admin' ? 'selected' : ''}>ADMIN</option>
                        </select>
                    `;
                } else if (field === 'department') {
                    inputHtml = `
                        <select name="${field}" class="w-full db-input px-3 py-2 text-sm font-mono">
                            <option value="">SELECT DEPARTMENT</option>
                            <option value="IT" ${value === 'IT' ? 'selected' : ''}>IT</option>
                            <option value="HR" ${value === 'HR' ? 'selected' : ''}>HR</option>
                            <option value="SALES" ${value === 'Sales' ? 'selected' : ''}>SALES</option>
                            <option value="MARKETING" ${value === 'Marketing' ? 'selected' : ''}>MARKETING</option>
                        </select>
                    `;
                } else {
                    inputHtml = `
                        <input type="${inputType}" 
                            name="${field}" 
                            value="${value}" 
                            class="w-full db-input px-3 py-2 text-sm font-mono"
                            onkeyup="checkAvatarField(this)">
                    `;
                }
                
                let displayName = field.toUpperCase();
                if (isAvatarField(field)) displayName = 'AVATAR URL';
                
                html += `
                    <div class="mb-4">
                        <label class="block text-cyan-400 text-xs mb-1">${displayName}</label>
                        ${inputHtml}
                        ${isAvatarField(field) && value ? `
                            <div class="mt-2">
                                <button type="button" onclick="testSpecificUrl('${field}')" class="text-xs text-cyan-400/70 hover:text-cyan-400">
                                    TEST IMAGE
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // JSON input
            html += `
                <div class="mb-4 border-t border-[#2a2f35] pt-4">
                    <label class="block text-cyan-400 text-xs mb-1">JSON DATA</label>
                    <textarea id="jsonInput" rows="3" class="w-full db-input px-3 py-2 text-xs font-mono" 
                        placeholder='{"field": "value"}'></textarea>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Check for avatar fields
            const avatarField = fields.find(f => isAvatarField(f));
            if (avatarField && existingData[avatarField]) {
                showAvatarPreview(existingData[avatarField]);
            }
        }

        function checkAvatarField(element) {
            if (isAvatarField(element.name) && element.value) {
                showAvatarPreview(element.value);
            }
        }

        function showAvatarPreview(url) {
            if (!url) {
                document.getElementById('avatarPreviewContainer').classList.add('hidden');
                return;
            }
            
            const preview = document.getElementById('avatarPreview');
            const status = document.getElementById('avatarStatus');
            
            preview.src = url;
            status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>LOADING...';
            document.getElementById('avatarPreviewContainer').classList.remove('hidden');
            
            const img = new Image();
            img.onload = function() {
                status.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-2"></i>IMAGE LOADED';
            };
            img.onerror = function() {
                status.innerHTML = '<i class="fas fa-exclamation-circle text-red-400 mr-2"></i>INVALID IMAGE URL';
                preview.src = 'https://ui-avatars.com/api/?name=ERROR&background=ff4444&color=fff';
            };
            img.src = url;
        }

        function testSpecificUrl(fieldName) {
            const input = document.querySelector(`[name="${fieldName}"]`);
            if (input && input.value) {
                showAvatarPreview(input.value);
            }
        }

        function testImageUrl() {
            const avatarInputs = document.querySelectorAll('input');
            for (let input of avatarInputs) {
                if (isAvatarField(input.name) && input.value) {
                    showAvatarPreview(input.value);
                    break;
                }
            }
        }

        function saveData(event) {
            event.preventDefault();
            
            const collection = document.getElementById('modalCollection').value;
            const key = document.getElementById('modalKey').value;
            const jsonInput = document.getElementById('jsonInput').value;
            
            let data = {};
            
            if (jsonInput.trim()) {
                try {
                    data = JSON.parse(jsonInput);
                } catch (e) {
                    showToast('INVALID JSON FORMAT', 'error');
                    return;
                }
            } else {
                const formData = new FormData(event.target);
                for (let [field, value] of formData.entries()) {
                    if (field !== 'jsonInput') {
                        data[field] = value;
                    }
                }
            }
            
            const now = new Date().toISOString();
            if (key) {
                data.updatedAt = now;
            } else {
                data.createdAt = now;
                data.updatedAt = now;
            }
            
            const ref = database.ref(collection);
            
            if (key) {
                ref.child(key).update(data)
                    .then(() => {
                        closeModal();
                        showToast('RECORD UPDATED', 'success');
                        loadAllData();
                    })
                    .catch(error => {
                        showToast('ERROR: ' + error.message, 'error');
                    });
            } else {
                ref.push(data)
                    .then(() => {
                        closeModal();
                        showToast('RECORD CREATED', 'success');
                        loadAllData();
                    })
                    .catch(error => {
                        showToast('ERROR: ' + error.message, 'error');
                    });
            }
        }

        function openDeleteModal(collection, key) {
            currentDelete = { collection, key };
            document.getElementById('deleteMessage').textContent = `DELETE RECORD FROM ${collection}?`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            currentDelete = { collection: null, key: null };
            document.getElementById('deleteModal').classList.add('hidden');
        }

        function confirmDelete() {
            if (!currentDelete.collection || !currentDelete.key) return;
            
            database.ref(`${currentDelete.collection}/${currentDelete.key}`).remove()
                .then(() => {
                    closeDeleteModal();
                    showToast('RECORD DELETED', 'success');
                    loadAllData();
                })
                .catch(error => {
                    showToast('ERROR: ' + error.message, 'error');
                    closeDeleteModal();
                });
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('avatarPreviewContainer').classList.add('hidden');
        }

        function refreshAllData() {
            loadAllData();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            let bgClass = 'db-toast';
            if (type === 'success') bgClass += ' border-green-400 text-green-400';
            if (type === 'error') bgClass += ' border-red-400 text-red-400';
            if (type === 'info') bgClass += ' border-cyan-400 text-cyan-400';
            
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${bgClass}`;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            const deleteModal = document.getElementById('deleteModal');
            const imageModal = document.getElementById('imageModal');
            const exportModal = document.getElementById('exportModal');
            const historyModal = document.getElementById('historyModal');
            
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
            if (event.target === imageModal) {
                closeImageModal();
            }
            if (event.target === exportModal) {
                closeExportModal();
            }
            if (event.target === historyModal) {
                closeHistoryModal();
            }
        }
    </script>
</body>
</html>
