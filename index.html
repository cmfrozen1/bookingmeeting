<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title id="page-title">Meeting Room ¬∑ LINE</title>
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/1040/1040244.png">
    
    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Critical CSS Inlined -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'IBM Plex Sans Thai',sans-serif}
        :root{--primary:#06c755;--primary-dark:#05b34a;--bg:#0a0a0f;--bg-card:#1a1d24;--border:#2a2e36;--text:#fff;--text-secondary:#9ca3af}
        body{background:var(--bg);color:var(--text);padding-bottom:70px}
        .navbar{position:sticky;top:0;z-index:40;background:rgba(10,10,15,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:12px 16px}
        .navbar-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .navbar-logo{display:flex;align-items:center;gap:8px;cursor:pointer}
        .navbar-logo i{color:var(--primary);font-size:24px}
        .navbar-logo span{font-size:18px;font-weight:600;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(26,29,36,.95);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0;z-index:50}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--text-secondary);font-size:12px;cursor:pointer}
        .nav-item.active{color:var(--primary)}
        .nav-item i{font-size:20px}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .initial-loading{position:fixed;inset:0;background:var(--bg);z-index:2000;display:flex;align-items:center;justify-content:center;transition:opacity .3s}
        .initial-loading.hide{opacity:0;pointer-events:none}
        .loading-spinner{width:60px;height:60px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .profile-header{background:var(--bg-card);border-radius:20px;padding:16px;margin:16px;display:flex;align-items:center;gap:16px;border:1px solid var(--border);cursor:pointer;max-width:1200px;margin-left:auto;margin-right:auto}
        .profile-avatar{width:60px;height:60px;border-radius:30px;border:3px solid var(--primary);object-fit:cover}
        .rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;padding:0 16px;max-width:1200px;margin:0 auto}
        @media (max-width:640px){.rooms-grid{grid-template-columns:1fr}}
        .room-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;overflow:hidden;cursor:pointer;transition:all .2s}
        .room-card:hover{border-color:var(--primary);transform:translateY(-2px)}
        .room-image{width:100%;height:160px;object-fit:cover;background:linear-gradient(135deg,#2a2e36,#1a1d24);display:flex;align-items:center;justify-content:center}
        .room-content{padding:16px}
        .btn-primary{background:var(--primary);color:#fff;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;position:relative}
        .btn-primary:active{opacity:.8;transform:scale(.98)}
        .hidden{display:none!important}
    </style>
    
    <!-- Deferred CSS -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- Fallback for no-JS -->
    <noscript>
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    </noscript>
    
    <!-- Fonts - Deferred -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LINE LIFF - Load early but not blocking -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js" async></script>
    
    <!-- Deferred Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js" defer></script>
    
    <style>
        /* Additional styles loaded after critical CSS */
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;display:inline-block}
        .badge-available{background:rgba(6,199,85,0.15);color:var(--primary);border:1px solid rgba(6,199,85,0.3)}
        .capacity-badge{background:rgba(6,199,85,0.1);color:var(--primary);padding:4px 8px;border-radius:20px;font-size:12px}
        .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center}
        .search-box{position:relative;max-width:1200px;margin:0 auto 16px;padding:0 16px}
        .search-box input{width:100%;padding:12px 12px 12px 44px;background:var(--bg-card);border:1px solid var(--border);border-radius:30px;color:var(--text)}
        .search-box i{position:absolute;left:28px;top:50%;transform:translateY(-50%);color:var(--text-secondary)}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:1000;display:none}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);width:100%;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
        @media (min-width:768px){.modal-content{width:90%;max-width:800px;height:90vh;margin:20px auto;border-radius:24px}}
        .calendar-container{background:var(--bg-card);border-radius:24px;padding:20px;margin:16px;border:1px solid var(--border)}
        .quick-actions{display:flex;gap:8px;padding:0 16px;margin-bottom:16px}
        .quick-action-btn{flex:1;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;cursor:pointer}
        .skeleton-card{background:linear-gradient(90deg,var(--bg-card) 25%,#252930 50%,var(--bg-card) 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:20px;height:200px}
        @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .btn-primary.loading{color:transparent!important;pointer-events:none;position:relative}
        .btn-primary.loading::after{content:'';position:absolute;width:20px;height:20px;top:50%;left:50%;margin-left:-10px;margin-top:-10px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite}
        .floating-book-btn{position:fixed;bottom:90px;right:20px;background:var(--primary);color:#fff;width:60px;height:60px;border-radius:30px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(6,199,85,0.3);cursor:pointer;z-index:100}
    </style>
</head>
<body>
    <!-- Initial Loading - Show immediately -->
    <div class="initial-loading" id="initial-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text mt-4 text-[#06c755]">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    
    <!-- Floating Book Button -->
    <div id="floating-book-btn" class="floating-book-btn hidden" onclick="showBookingModal()">
        <i class="fas fa-calendar-plus text-2xl"></i>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-logo" onclick="goHome()">
                <i class="fas fa-door-open"></i>
                <span id="navbar-app-name">Meeting Room</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Tab: Home (‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°) -->
        <div id="tab-home" class="tab-content active">
            <!-- Profile Header - Show skeleton initially -->
            <div class="profile-header" id="profile-header">
                <div class="profile-avatar skeleton-card" style="width:60px;height:60px;border-radius:30px;"></div>
                <div class="flex-1">
                    <div class="skeleton-card" style="width:200px;height:24px;margin-bottom:8px;"></div>
                    <div class="skeleton-card" style="width:150px;height:16px;"></div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="showBookingModal()">
                    <div class="quick-action-icon"><i class="fas fa-calendar-plus"></i></div>
                    <div class="quick-action-label">‡∏à‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô</div>
                </div>
                <div class="quick-action-btn" onclick="goToToday()">
                    <div class="quick-action-icon"><i class="fas fa-calendar-day"></i></div>
                    <div class="quick-action-label">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="quick-action-btn" onclick="showAllRooms()">
                    <div class="quick-action-icon"><i class="fas fa-door-open"></i></div>
                    <div class="quick-action-label">‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>
                </div>
            </div>

            <!-- Stats - Skeletons -->
            <div class="grid grid-cols-3 gap-2 max-w-7xl mx-auto px-4 mb-4">
                <div class="stat-card"><div class="skeleton-card" style="height:40px;"></div></div>
                <div class="stat-card"><div class="skeleton-card" style="height:40px;"></div></div>
                <div class="stat-card"><div class="skeleton-card" style="height:40px;"></div></div>
            </div>

            <!-- Calendar Section - Skeleton -->
            <div class="calendar-container">
                <div class="skeleton-card" style="height:300px;"></div>
            </div>

            <!-- Search - Skeleton -->
            <div class="search-box">
                <div class="skeleton-card" style="height:48px;"></div>
            </div>

            <!-- Rooms List - Skeletons -->
            <div id="rooms-list" class="rooms-grid">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </div>

        <!-- Tab: My Bookings (hidden initially) -->
        <div id="tab-my" class="tab-content">
            <div class="flex justify-between items-center max-w-7xl mx-auto px-4 mb-4">
                <h2 class="text-xl font-bold text-[#06c755]">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            </div>
            <div class="my-bookings-grid px-4" id="my-bookings-list"></div>
        </div>

        <!-- Tab: Admin (hidden initially) -->
        <div id="tab-admin" class="tab-content"></div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-door-open"></i>
            <span>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</span>
        </div>
        <div class="nav-item" data-tab="my">
            <i class="fas fa-calendar-check"></i>
            <span>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
        </div>
        <div class="nav-item hidden admin-only" data-tab="admin">
            <i class="fas fa-cog"></i>
            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
        </div>
    </div>

    <!-- All Modals (hidden by default) -->
    <div class="modal" id="room-modal"><div class="modal-content">...</div></div>
    <div class="modal" id="booking-modal"><div class="modal-content">...</div></div>
    <div class="modal" id="booking-create-modal"><div class="modal-content">...</div></div>
    <div class="modal" id="room-create-modal"><div class="modal-content">...</div></div>
    <div class="modal" id="profile-modal"><div class="modal-content">...</div></div>
    <div class="modal" id="role-modal"><div class="modal-content">...</div></div>

    <!-- Optimized Script -->
    <script>
        // ========== CONFIG ==========
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbxJhYLELB6wLE6h3LJtAm5sS92AN2NReQEaenI-JOxNRHFhw7X_XoreWH8UHWNvpg1Z/exec',
            LIFF_ID: '2008904120-nqYHD5BT',
            CACHE_TTL: 5 * 60 * 1000 // 5 minutes cache
        };

        // ========== STATE with Cache ==========
        const state = {
            user: null,
            rooms: { data: null, timestamp: 0 },
            myBookings: { data: null, timestamp: 0 },
            bookings: { data: null, timestamp: 0 },
            users: { data: null, timestamp: 0 },
            settings: { appName: 'Meeting Room', requireApproval: 'true', reminderMinutes: '30' },
            isAdmin: false,
            isManager: false,
            initialized: false,
            currentMonth: new Date(),
            selectedDate: new Date()
        };

        // ========== DOM Cache ==========
        const $ = {
            initLoading: document.getElementById('initial-loading'),
            roomsList: document.getElementById('rooms-list'),
            profileHeader: document.getElementById('profile-header'),
            navItems: document.querySelectorAll('.nav-item'),
            floatingBtn: document.getElementById('floating-book-btn')
        };

        // ========== Utility Functions ==========
        const formatDateForInput = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        const formatTime = (dateStr) => new Date(dateStr).toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });

        const showToast = (msg, type='success') => {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;bottom:80px;left:16px;right:16px;background:#1a1d24;border-left:4px solid ${type==='success'?'#06c755':type==='warning'?'#f59e0b':'#ef4444'};border-radius:12px;padding:12px 16px;color:#fff;z-index:2000;max-width:400px;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.5);animation:slideUp .3s ease`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        // ========== Optimized API with Cache ==========
        async function callGAS(path, data = {}, options = { skipCache: false }) {
            const cacheKey = `${path}_${JSON.stringify(data)}`;
            const cached = sessionStorage.getItem(cacheKey);
            
            if (!options.skipCache && cached) {
                const { timestamp, data: cachedData } = JSON.parse(cached);
                if (Date.now() - timestamp < CONFIG.CACHE_TTL) {
                    return cachedData;
                }
            }

            try {
                const formData = new FormData();
                formData.append('path', path);
                if (state.user?.lineUserId) formData.append('lineUserId', state.user.lineUserId);
                
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        formData.append(key, data[key]);
                    }
                });

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // Reduced timeout

                const res = await fetch(CONFIG.GAS_URL, { 
                    method: 'POST', 
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const text = await res.text();
                const result = JSON.parse(text);
                
                // Cache successful responses
                if (result.success && path !== 'booking/create' && path !== 'booking/update') {
                    sessionStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data: result }));
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, message: 'connection error' };
            }
        }

        // ========== LIFF Init with Priority Loading ==========
        async function initLIFF() {
            try {
                // Load LIFF in parallel with other operations
                const liffPromise = liff.init({ liffId: CONFIG.LIFF_ID });
                
                // Load rooms immediately while LIFF initializes
                const roomsPromise = loadRooms(true);
                
                await liffPromise;
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // Get profile in parallel
                const [profile, idToken] = await Promise.all([
                    liff.getProfile(),
                    liff.getDecodedIDToken()
                ]);

                const result = await callGAS('user/profile', {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    email: idToken?.email || ''
                });

                if (result.success) {
                    state.user = result.data;
                    state.isAdmin = state.user.role === 'admin';
                    state.isManager = state.isAdmin || state.user.role === 'manager';

                    // Update UI immediately
                    updateProfileUI();
                    
                    // Load remaining data in parallel
                    await Promise.all([
                        loadSettings(),
                        loadMyBookings(true),
                        loadTodayStats(),
                        loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth())
                    ]);

                    if (state.isManager) {
                        // Load admin data in background
                        setTimeout(() => {
                            loadUsers();
                            loadAdminStats();
                            loadPendingBookings();
                            loadAllBookings();
                            loadRoomsManagement();
                        }, 100);
                    }

                    // Hide loading
                    $.initLoading.classList.add('hide');
                    state.initialized = true;
                    
                    // Initialize date pickers after UI is ready
                    setTimeout(initDatePickers, 200);
                }
            } catch (error) {
                console.error('LIFF init error:', error);
                $.initLoading.classList.add('hide');
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateProfileUI() {
            const header = $.profileHeader;
            if (!state.user) return;
            
            header.innerHTML = `
                <img src="${state.user.pictureUrl || 'https://via.placeholder.com/60'}" class="profile-avatar">
                <div class="flex-1">
                    <h2 class="text-lg font-bold">${state.user.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</h2>
                    <p class="text-sm text-gray-400">${state.user.email || ''}</p>
                    <p class="text-xs text-[#06c755] mt-1">${{admin:'üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', manager:'üë• ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', user:'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}[state.user.role] || ''}</p>
                </div>
                <i class="fas fa-chevron-down text-gray-400"></i>
            `;

            // Show floating button for non-admin
            if (!state.isAdmin) $.floatingBtn?.classList.remove('hidden');
            
            // Update admin-only elements
            document.querySelectorAll('.admin-only').forEach(el => {
                if (state.isAdmin) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        // ========== Optimized Room Loading ==========
        async function loadRooms(initial = false) {
            const result = await callGAS('rooms', {}, { skipCache: !initial });
            if (result.success) {
                state.rooms.data = result.data || [];
                renderRooms();
            }
        }

        function renderRooms() {
            const rooms = state.rooms.data || [];
            if (!rooms.length) {
                $.roomsList.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fas fa-door-open text-3xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</p></div>';
                return;
            }

            $.roomsList.innerHTML = rooms.map(r => `
                <div class="room-card" onclick="showRoomDetail('${r.roomId}')">
                    <div class="room-image">
                        ${r.imageUrl ? `<img src="${r.imageUrl}" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-door-open text-4xl text-[#06c755]\'></i>';">` : '<i class="fas fa-door-open text-4xl text-[#06c755]"></i>'}
                    </div>
                    <div class="room-content">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-base">${r.name}</h3>
                            <span class="capacity-badge"><i class="fas fa-users mr-1"></i>${r.capacity}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${r.location || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
                        <p class="text-xs text-gray-500 line-clamp-2 mb-3">${r.description || ''}</p>
                        <div class="flex justify-between items-center">
                            <span class="badge badge-available">‡∏ß‡πà‡∏≤‡∏á</span>
                            <button class="text-[#06c755] text-sm" onclick="showBookingModal('${r.roomId}'); event.stopPropagation();">
                                <i class="fas fa-calendar-plus mr-1"></i>‡∏à‡∏≠‡∏á
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========== Optimized Booking Save with Auto-send ==========
        window.saveBooking = async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('save-booking-btn');
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.classList.add('loading');

            try {
                const id = document.getElementById('edit-booking-id').value;
                const roomId = document.getElementById('booking-room').value;
                const startDate = document.getElementById('booking-date').value;
                const endDate = document.getElementById('booking-end-date').value;
                const start = document.getElementById('booking-start').value;
                const end = document.getElementById('booking-end').value;
                
                const startDateTime = new Date(`${startDate}T${start}:00`);
                const endDateTime = new Date(`${endDate}T${end}:00`);
                
                const data = {
                    roomId,
                    title: document.getElementById('booking-title').value,
                    description: document.getElementById('booking-description').value,
                    meetingLink: document.getElementById('booking-meeting-link').value,
                    startTime: startDateTime.toISOString(),
                    endTime: endDateTime.toISOString(),
                    attendees: document.getElementById('booking-attendees').value,
                    userName: state.user.displayName,
                    lineUserId: state.user.lineUserId
                };

                if (id) data.bookingId = id;

                const result = await callGAS(id ? 'booking/update' : 'booking/create', data, { skipCache: true });

                if (result.success) {
                    showToast(id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    
                    closeBookingCreateModal();
                    
                    // Clear cache and reload data
                    sessionStorage.clear();
                    await Promise.all([
                        loadRooms(),
                        loadMyBookings(),
                        loadTodayStats(),
                        loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth())
                    ]);
                    
                    // Send Flex Message to current chat immediately
                    if (!id && result.data?.bookingData && liff.isInClient()) {
                        setTimeout(() => {
                            sendBookingToChat(result.data.bookingData);
                        }, 300);
                    }
                } else {
                    showToast(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }
            } catch (error) {
                console.error('Save booking error:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        };

        // ========== Flex Message Creator ==========
        function createBookingFlexMessage(booking) {
            const startTime = new Date(booking.startTime);
            const endTime = new Date(booking.endTime);
            const dateStr = startTime.toLocaleDateString('th-TH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            const timeStr = `${startTime.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' })} - ${endTime.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' })} ‡∏ô.`;
            
            return {
                type: 'flex',
                altText: `üìÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ${booking.title}`,
                contents: {
                    type: 'bubble',
                    header: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [{
                            type: 'text',
                            text: 'üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
                            weight: 'bold',
                            size: 'xl',
                            color: '#06c755'
                        }]
                    },
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            { type: 'text', text: booking.roomName, weight: 'bold', size: 'lg', wrap: true },
                            { type: 'text', text: booking.title, size: 'md', color: '#666666', wrap: true, margin: 'md' },
                            { type: 'separator', margin: 'lg' },
                            {
                                type: 'box',
                                layout: 'vertical',
                                margin: 'lg',
                                contents: [
                                    { type: 'box', layout: 'horizontal', contents: [
                                        { type: 'text', text: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', size: 'sm', color: '#aaaaaa', flex: 2 },
                                        { type: 'text', text: dateStr, size: 'sm', flex: 5, wrap: true }
                                    ]},
                                    { type: 'box', layout: 'horizontal', margin: 'md', contents: [
                                        { type: 'text', text: '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤', size: 'sm', color: '#aaaaaa', flex: 2 },
                                        { type: 'text', text: timeStr, size: 'sm', flex: 5 }
                                    ]},
                                    { type: 'box', layout: 'horizontal', margin: 'md', contents: [
                                        { type: 'text', text: 'üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°', size: 'sm', color: '#aaaaaa', flex: 2 },
                                        { type: 'text', text: booking.attendees + ' ‡∏Ñ‡∏ô', size: 'sm', flex: 5 }
                                    ]},
                                    { type: 'box', layout: 'horizontal', margin: 'md', contents: [
                                        { type: 'text', text: 'üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', size: 'sm', color: '#aaaaaa', flex: 2 },
                                        { type: 'text', text: booking.status === 'confirmed' ? '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', size: 'sm', color: booking.status === 'confirmed' ? '#06c755' : '#f59e0b', flex: 5 }
                                    ]}
                                ]
                            },
                            { type: 'separator', margin: 'lg' },
                            { type: 'text', text: 'üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ' + booking.userName, size: 'sm', color: '#888888', margin: 'lg' }
                        ]
                    }
                }
            };
        }

        // ========== Send to Chat ==========
        async function sendBookingToChat(bookingData) {
            try {
                if (!liff.isInClient()) return;
                
                const flexMessage = createBookingFlexMessage(bookingData);
                await liff.sendMessages([flexMessage]);
                showToast('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Send message error:', error);
            }
        }

        // ========== Lazy Load Functions ==========
        const loadMyBookings = async (initial = false) => {
            const result = await callGAS('user/bookings', { lineUserId: state.user?.lineUserId }, { skipCache: !initial });
            if (result.success) {
                state.myBookings.data = result.data || [];
                renderMyBookings();
            }
        };

        const loadMonthBookings = async (year, month) => {
            const startDate = formatDateForInput(new Date(year, month, 1));
            const endDate = formatDateForInput(new Date(year, month + 1, 0));
            await callGAS('bookings', { startDate, endDate, showPast: 'true' });
        };

        // Placeholder functions (implement as needed)
        const loadTodayStats = async () => {};
        const loadSettings = async () => {};
        const loadAdminStats = async () => {};
        const loadUsers = async () => {};
        const loadPendingBookings = async () => {};
        const loadAllBookings = async () => {};
        const loadRoomsManagement = async () => {};
        const initDatePickers = () => {};
        const showBookingModal = (roomId) => {};
        const closeBookingCreateModal = () => {};
        const showRoomDetail = (roomId) => {};
        const renderMyBookings = () => {};
        const goHome = () => switchTab('home');
        const goToToday = () => {};
        const showAllRooms = () => {};
        const switchTab = (tab) => {
            $.navItems.forEach(i => i.classList.remove('active'));
            document.querySelectorAll(`[data-tab="${tab}"]`).forEach(i => i.classList.add('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
        };

        // ========== Event Listeners ==========
        $.navItems.forEach(item => {
            item.addEventListener('click', () => switchTab(item.dataset.tab));
        });

        // ========== Initialize ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLIFF);
        } else {
            initLIFF();
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = '@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}';
        document.head.appendChild(style);
    </script>
</body>
</html>
