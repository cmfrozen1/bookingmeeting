<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title id="page-title">Meeting Room · LINE</title>
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/1040/1040244.png">
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LINE LIFF -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
    
    <style>
        /* ===== CSS Variables ===== */
        :root {
            --primary: #06c755;
            --primary-dark: #05b34a;
            --primary-light: rgba(6,199,85,0.1);
            --bg: #0a0a0f;
            --bg-card: #1a1d24;
            --border: #2a2e36;
            --text: #ffffff;
            --text-secondary: #9ca3af;
            --navbar-bg: rgba(10, 10, 15, 0.95);
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --success: #06c755;
        }

        * {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 70px;
        }

        /* ===== Navbar ===== */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 40;
            background: var(--navbar-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .navbar-logo i {
            color: var(--primary);
            font-size: 24px;
        }

        .navbar-logo span {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ===== Bottom Navigation ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            background: rgba(26, 29, 36, 0.95);
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                max-width: 400px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: 50px;
                margin-bottom: 10px;
            }
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            font-size: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Cards ===== */
        .room-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .room-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .room-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: linear-gradient(135deg, #2a2e36, #1a1d24);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .room-content {
            padding: 16px;
        }

        /* ===== Badges ===== */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-available {
            background: rgba(6,199,85,0.15);
            color: var(--primary);
            border: 1px solid rgba(6,199,85,0.3);
        }

        .badge-pending {
            background: rgba(245,158,11,0.15);
            color: #f59e0b;
            border: 1px solid rgba(245,158,11,0.3);
        }

        .badge-confirmed {
            background: rgba(6,199,85,0.15);
            color: var(--primary);
            border: 1px solid rgba(6,199,85,0.3);
        }

        .badge-cancelled {
            background: rgba(156,163,175,0.15);
            color: #9ca3af;
            border: 1px solid rgba(156,163,175,0.3);
        }

        .badge-rejected {
            background: rgba(239,68,68,0.15);
            color: #ef4444;
            border: 1px solid rgba(239,68,68,0.3);
        }

        .capacity-badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* ===== Buttons ===== */
        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .btn-primary:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary.loading {
            color: transparent !important;
            pointer-events: none;
            position: relative;
        }

        .btn-primary.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .btn-outline:hover {
            background: rgba(255,255,255,0.05);
            border-color: var(--primary);
        }

        .btn-outline.loading {
            color: transparent !important;
            pointer-events: none;
            position: relative;
        }

        .btn-outline.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid var(--text);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-danger.loading {
            color: transparent !important;
            pointer-events: none;
            position: relative;
        }

        .btn-danger.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .btn-success {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-success.loading {
            color: transparent !important;
            pointer-events: none;
            position: relative;
        }

        .btn-success.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== Profile ===== */
        .profile-header {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 16px;
            margin: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.2s;
        }

        .profile-header:hover {
            border-color: var(--primary);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            border: 3px solid var(--primary);
            object-fit: cover;
        }

        /* ===== Stats ===== */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        /* ===== Quick Actions ===== */
        .quick-actions {
            display: flex;
            gap: 8px;
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .quick-action-btn {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            background: rgba(6,199,85,0.05);
        }

        .quick-action-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .quick-action-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ===== Search ===== */
        .search-box {
            position: relative;
            max-width: 1200px;
            margin: 0 auto 16px;
            padding: 0 16px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 30px;
            color: var(--text);
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(6,199,85,0.2);
        }

        .search-box i {
            position: absolute;
            left: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* ===== Modal ===== */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            z-index: 1000;
            display: none;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .modal-content {
                width: 90%;
                max-width: 800px;
                height: 90vh;
                margin: 20px auto;
                border-radius: 24px;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.1);
            color: var(--primary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .modal-body::-webkit-scrollbar {
            width: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .modal-footer button {
            flex: 1;
        }

        /* ===== Forms ===== */
        .input-field {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(6,199,85,0.2);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        /* ===== Calendar ===== */
        .calendar-container {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 20px;
            margin: 16px;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-month {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-nav-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            position: relative;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
            font-weight: bold;
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.has-booking {
            background: rgba(6,199,85,0.1);
            border: 1px solid var(--primary);
        }

        .calendar-day.has-booking::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            border-radius: 2px;
            background: var(--primary);
        }

        .calendar-day.has-booking.multiple::after {
            width: 8px;
            background: var(--warning);
        }

        .date-bookings-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .date-booking-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-booking-item:hover {
            background: #252930;
            transform: translateX(4px);
        }

        .date-booking-item.pending {
            border-left-color: var(--warning);
        }

        .date-booking-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .date-booking-title {
            font-weight: 600;
            margin: 4px 0;
        }

        .date-booking-room {
            font-size: 12px;
            color: var(--primary);
        }

        /* ===== Admin ===== */
        .admin-section {
            background: linear-gradient(135deg, rgba(6,199,85,0.1), transparent);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .admin-stat {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .user-row:hover {
            border-color: var(--primary);
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            object-fit: cover;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .role-admin {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }

        .role-manager {
            background: rgba(245,158,11,0.2);
            color: #f59e0b;
        }

        .role-user {
            background: rgba(107,114,128,0.2);
            color: #9ca3af;
        }

        .admin-tab-btn {
            padding: 12px;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .admin-tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .room-management-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-management-item:hover {
            border-color: var(--primary);
        }

        .room-management-info {
            flex: 1;
        }

        .room-management-actions {
            display: flex;
            gap: 8px;
        }

        /* ===== Upload ===== */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(6,199,85,0.05);
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 12px;
            display: none;
        }

        /* ===== Facility Tags ===== */
        .facility-tag {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 11px;
            color: var(--text-secondary);
            display: inline-block;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        /* ===== Loading ===== */
        .initial-loading {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }

        .initial-loading.hide {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-spinner-small {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }

        .skeleton-card {
            background: linear-gradient(90deg, var(--bg-card) 25%, #252930 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 20px;
            height: 200px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== Floating Button ===== */
        .floating-book-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(6,199,85,0.3);
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s;
        }

        .floating-book-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(6,199,85,0.4);
        }

        /* ===== Grid Layouts ===== */
        @media (min-width: 1024px) {
            .rooms-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 16px;
            }
            
            .my-bookings-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 16px;
            }
        }
        
        @media (max-width: 1023px) {
            .rooms-grid, .my-bookings-grid {
                display: flex;
                flex-direction: column;
                gap: 16px;
                padding: 0 16px;
            }
        }

        .hidden {
            display: none !important;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Initial Loading -->
    <div class="initial-loading" id="initial-loading">
        <div class="loading-spinner"></div>
        <div class="mt-4 text-[#06c755] font-medium">กำลังโหลด...</div>
    </div>
    
    <!-- Floating Book Button -->
    <div id="floating-book-btn" class="floating-book-btn hidden" onclick="showBookingModal()">
        <i class="fas fa-calendar-plus text-2xl"></i>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-logo" onclick="goHome()">
                <i class="fas fa-door-open"></i>
                <span id="navbar-app-name">Meeting Room</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Tab: Home (ห้องประชุม) -->
        <div id="tab-home" class="tab-content active">
            <!-- Profile Header -->
            <div class="profile-header" id="profile-header">
                <img id="profile-avatar" src="https://via.placeholder.com/60/2a2e36/06c755?text=..." alt="avatar" class="profile-avatar">
                <div class="flex-1 min-w-0">
                    <h2 id="profile-name" class="text-lg font-bold truncate">กำลังโหลด...</h2>
                    <p id="profile-email" class="text-sm text-gray-400 truncate"></p>
                    <p id="profile-role" class="text-xs text-[#06c755] mt-1"></p>
                </div>
                <i class="fas fa-chevron-down text-gray-400 flex-shrink-0"></i>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="showBookingModal()">
                    <div class="quick-action-icon"><i class="fas fa-calendar-plus"></i></div>
                    <div class="quick-action-label">จองด่วน</div>
                </div>
                <div class="quick-action-btn" onclick="goToToday()">
                    <div class="quick-action-icon"><i class="fas fa-calendar-day"></i></div>
                    <div class="quick-action-label">วันนี้</div>
                </div>
                <div class="quick-action-btn" onclick="showAllRooms()">
                    <div class="quick-action-icon"><i class="fas fa-door-open"></i></div>
                    <div class="quick-action-label">ห้องว่าง</div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-2 max-w-7xl mx-auto px-4 mb-4">
                <div class="stat-card">
                    <p class="text-xs text-gray-400">ห้องทั้งหมด</p>
                    <p id="stat-rooms" class="text-xl font-bold text-[#06c755]">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs text-gray-400">จองวันนี้</p>
                    <p id="stat-today" class="text-xl font-bold text-[#06c755]">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs text-gray-400">รออนุมัติ</p>
                    <p id="stat-pending" class="text-xl font-bold text-yellow-500">0</p>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="calendar-month" id="current-month">กำลังโหลด...</span>
                    <button class="calendar-nav-btn" onclick="changeMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div class="calendar-weekdays">
                    <div>อา</div>
                    <div>จ</div>
                    <div>อ</div>
                    <div>พ</div>
                    <div>พฤ</div>
                    <div>ศ</div>
                    <div>ส</div>
                </div>
                
                <div class="calendar-days" id="calendar-days">
                    <!-- Calendar days will be rendered here -->
                </div>
                
                <!-- Selected Date Bookings -->
                <div id="selected-date-bookings" class="date-bookings-list hidden">
                    <h3 class="text-sm font-semibold mb-2" id="selected-date-title"></h3>
                    <div id="selected-date-bookings-list"></div>
                </div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="ค้นหาห้องประชุม..." autocomplete="off">
            </div>

            <!-- Rooms List -->
            <div id="rooms-list" class="rooms-grid">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </div>

        <!-- Tab: My Bookings -->
        <div id="tab-my" class="tab-content">
            <div class="flex justify-between items-center max-w-7xl mx-auto px-4 mb-4">
                <h2 class="text-xl font-bold text-[#06c755]">การจองของฉัน</h2>
                <button id="quick-book-btn" class="bg-[#06c755] text-white px-4 py-2 rounded-xl text-sm hidden" onclick="showBookingModal()">
                    <i class="fas fa-plus mr-1"></i>จองด่วน
                </button>
            </div>
            
            <!-- Filter tabs -->
            <div class="flex gap-2 overflow-x-auto px-4 mb-4 pb-1">
                <button class="filter-btn active" data-booking-filter="all">ทั้งหมด</button>
                <button class="filter-btn" data-booking-filter="confirmed">อนุมัติแล้ว</button>
                <button class="filter-btn" data-booking-filter="pending">รออนุมัติ</button>
                <button class="filter-btn" data-booking-filter="cancelled">ยกเลิก</button>
                <button class="filter-btn" data-booking-filter="rejected">ปฏิเสธ</button>
            </div>
            
            <div id="my-bookings-list" class="my-bookings-grid"></div>
        </div>

        <!-- Tab: Admin -->
        <div id="tab-admin" class="tab-content">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-[#06c755]">จัดการระบบ</h2>
                    <button id="refresh-admin" class="text-[#06c755] text-sm flex items-center gap-1">
                        <i class="fas fa-sync-alt"></i>รีเฟรช
                    </button>
                </div>

                <!-- Admin Stats -->
                <div class="admin-section">
                    <h3 class="font-semibold mb-3">สถิติ</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="admin-stat">
                            <p class="text-xs text-gray-400">ผู้ใช้</p>
                            <p id="admin-users" class="text-xl font-bold text-[#06c755]">0</p>
                        </div>
                        <div class="admin-stat">
                            <p class="text-xs text-gray-400">ห้อง</p>
                            <p id="admin-rooms" class="text-xl font-bold text-[#06c755]">0</p>
                        </div>
                        <div class="admin-stat">
                            <p class="text-xs text-gray-400">การจอง</p>
                            <p id="admin-bookings" class="text-xl font-bold text-[#06c755]">0</p>
                        </div>
                        <div class="admin-stat">
                            <p class="text-xs text-gray-400">รออนุมัติ</p>
                            <p id="admin-pending" class="text-xl font-bold text-yellow-500">0</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="flex border-b border-[#2a2e36] mb-4 overflow-x-auto">
                    <button class="admin-tab-btn flex-1 py-2 text-center active" data-admin-tab="pending">
                        รออนุมัติ <span id="pending-badge" class="ml-1 bg-yellow-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</span>
                    </button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="bookings">การจองทั้งหมด</button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="rooms">จัดการห้อง</button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="users">จัดการผู้ใช้</button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="settings">ตั้งค่า</button>
                </div>

                <!-- Admin: Pending -->
                <div id="admin-pending-tab" class="admin-tab">
                    <h3 class="font-semibold mb-3">รายการรออนุมัติ</h3>
                    <div id="pending-bookings-list" class="space-y-3"></div>
                </div>

                <!-- Admin: All Bookings -->
                <div id="admin-bookings-tab" class="admin-tab hidden">
                    <div class="search-box px-0 mb-4">
                        <i class="fas fa-search"></i>
                        <input type="text" id="admin-booking-search" placeholder="ค้นหาการจอง...">
                    </div>
                    <div id="all-bookings-list" class="space-y-3"></div>
                </div>

                <!-- Admin: Rooms -->
                <div id="admin-rooms-tab" class="admin-tab hidden">
                    <button class="btn-primary w-full mb-4" onclick="showCreateRoomModal()">
                        <i class="fas fa-plus mr-2"></i>เพิ่มห้องใหม่
                    </button>
                    <div id="rooms-management-list" class="space-y-3"></div>
                </div>

                <!-- Admin: Users -->
                <div id="admin-users-tab" class="admin-tab hidden">
                    <div class="search-box px-0 mb-4">
                        <i class="fas fa-search"></i>
                        <input type="text" id="user-search" placeholder="ค้นหาผู้ใช้...">
                    </div>
                    <div id="users-list" class="space-y-2"></div>
                </div>

                <!-- Admin: Settings -->
                <div id="admin-settings-tab" class="admin-tab hidden">
                    <div class="admin-section">
                        <h3 class="font-semibold mb-3">ตั้งค่าระบบ</h3>
                        <form id="settings-form" onsubmit="saveSettings(event)">
                            <label class="block text-sm text-gray-400 mb-1">ชื่อระบบ</label>
                            <input type="text" id="setting-app-name" class="input-field" value="Meeting Room" required>
                            
                            <div class="mb-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="setting-require-approval" class="w-4 h-4 text-[#06c755] rounded border-gray-600 focus:ring-[#06c755] focus:ring-2">
                                    <span class="text-sm text-gray-400 select-none">ต้องอนุมัติการจองก่อน</span>
                                </label>
                            </div>
                            
                            <label class="block text-sm text-gray-400 mb-1">แจ้งเตือนล่วงหน้า (นาที)</label>
                            <select id="setting-reminder-minutes" class="input-field">
                                <option value="15">15 นาที</option>
                                <option value="30">30 นาที</option>
                                <option value="60">1 ชั่วโมง</option>
                                <option value="120">2 ชั่วโมง</option>
                            </select>
                            
                            <button type="submit" class="btn-primary w-full" id="settings-save-btn">บันทึกการตั้งค่า</button>
                        </form>
                    </div>
                    
                    <!-- Database Reset (Admin Only) -->
                    <div class="admin-section border-red-500/30">
                        <h3 class="font-semibold mb-3 text-red-500">⚠️ เครื่องมือสำหรับผู้ดูแล</h3>
                        <button onclick="resetDatabase()" class="btn-danger w-full">
                            <i class="fas fa-database mr-2"></i>รีเซ็ตฐานข้อมูล
                        </button>
                        <p class="text-xs text-gray-400 mt-2">คำเตือน: การกดปุ่มนี้จะล้างข้อมูลทั้งหมดและตั้งค่าเริ่มต้นใหม่</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-door-open"></i>
            <span>ห้องประชุม</span>
        </div>
        <div class="nav-item" data-tab="my">
            <i class="fas fa-calendar-check"></i>
            <span>การจองของฉัน</span>
        </div>
        <div class="nav-item hidden admin-only" data-tab="admin">
            <i class="fas fa-cog"></i>
            <span>จัดการ</span>
        </div>
    </div>

    <!-- ===== MODALS ===== -->

    <!-- Room Detail Modal -->
    <div class="modal" id="room-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">กำลังโหลด...</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="flex justify-center items-center py-10">
                    <div class="loading-spinner w-10 h-10"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="showBookingModal(state.currentRoom?.roomId)" id="modal-book-btn">
                    <i class="fas fa-calendar-check"></i> จองห้อง
                </button>
                <button class="btn-outline" onclick="closeModal()">ปิด</button>
            </div>
            <div id="modal-admin-controls" class="px-4 pb-4 hidden">
                <p class="text-sm text-gray-400 mb-2">จัดการห้อง</p>
                <div class="flex gap-2">
                    <button id="modal-edit-btn" class="btn-outline flex-1 text-sm" onclick="editCurrentRoom()" disabled>
                        <i class="fas fa-edit mr-2"></i>แก้ไข
                    </button>
                    <button id="modal-delete-btn" class="btn-danger flex-1 text-sm" onclick="deleteCurrentRoom()" disabled>
                        <i class="fas fa-trash mr-2"></i>ลบ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Detail Modal -->
    <div class="modal" id="booking-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">รายละเอียดการจอง</h3>
                <button class="modal-close" onclick="closeBookingDetailModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="booking-modal-body">
                <div class="flex justify-center items-center py-10">
                    <div class="loading-spinner w-10 h-10"></div>
                </div>
            </div>
            <div class="modal-footer" id="booking-modal-footer">
                <button class="btn-outline" onclick="closeBookingDetailModal()">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Booking Modal -->
    <div class="modal" id="booking-create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="booking-modal-title">จองห้องประชุม</h3>
                <button class="modal-close" onclick="closeBookingCreateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="booking-form" onsubmit="saveBooking(event)">
                    <input type="hidden" id="edit-booking-id">
                    
                    <select id="booking-room" class="input-field" required>
                        <option value="">เลือกห้องประชุม</option>
                    </select>
                    
                    <input type="text" id="booking-title" placeholder="หัวข้อการประชุม" class="input-field" required maxlength="100">
                    
                    <textarea id="booking-description" placeholder="รายละเอียด (เช่น วัตถุประสงค์, จำนวนผู้เข้าร่วม)" class="input-field" rows="3" maxlength="500"></textarea>
                    
                    <input type="text" id="booking-meeting-link" placeholder="ลิงค์ประชุม (Zoom, Teams, etc.)" class="input-field">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">วันที่เริ่ม</label>
                            <input type="text" id="booking-date" class="input-field" placeholder="เลือกวันที่เริ่ม" required readonly>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">วันที่สิ้นสุด</label>
                            <input type="text" id="booking-end-date" class="input-field" placeholder="เลือกวันที่สิ้นสุด" required readonly>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">เวลาเริ่ม</label>
                            <input type="text" id="booking-start" class="input-field" placeholder="เลือกเวลา" required readonly>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">เวลาสิ้นสุด</label>
                            <input type="text" id="booking-end" class="input-field" placeholder="เลือกเวลา" required readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">จำนวนผู้เข้าร่วม</label>
                        <input type="number" id="booking-attendees" class="input-field" placeholder="จำนวน" min="1" value="4" required>
                    </div>
                    
                    <div id="availability-status" class="text-sm mb-3 hidden"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="booking-form" class="btn-primary flex-1" id="save-booking-btn">จอง</button>
                <button type="button" class="btn-outline flex-1" onclick="closeBookingCreateModal()">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Room Modal -->
    <div class="modal" id="room-create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="room-modal-title">เพิ่มห้องใหม่</h3>
                <button class="modal-close" onclick="closeRoomModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="room-form" onsubmit="saveRoom(event)">
                    <input type="hidden" id="edit-room-id">
                    
                    <input type="text" id="room-name" placeholder="ชื่อห้อง" class="input-field" required maxlength="50">
                    
                    <input type="number" id="room-capacity" placeholder="ความจุ (คน)" class="input-field" required min="1">
                    
                    <input type="text" id="room-location" placeholder="สถานที่/ชั้น" class="input-field" required>
                    
                    <textarea id="room-description" placeholder="รายละเอียดห้อง" class="input-field" rows="3"></textarea>
                    
                    <input type="text" id="room-facilities" placeholder="สิ่งอำนวยความสะดวก (คั่นด้วย , เช่น โปรเจคเตอร์, จอ, ไวท์บอร์ด)" class="input-field">
                    
                    <!-- อัปโหลดรูปภาพแบบใหม่ ไม่ใช้ Base64 -->
                    <div class="upload-area" onclick="document.getElementById('room-image-file').click()">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-400">คลิกเพื่ออัปโหลดรูปภาพห้อง</p>
                        <p class="text-xs text-gray-500 mt-1">(ขนาดไม่เกิน 2MB, JPG/PNG)</p>
                    </div>
                    
                    <input type="file" id="room-image-file" accept="image/jpeg,image/png" style="display: none" onchange="previewRoomImage(this)">
                    <img id="room-image-preview" class="image-preview">
                    <input type="hidden" id="room-image">
                    
                    <!-- แสดงสถานะการอัปโหลด -->
                    <div id="upload-progress" class="hidden text-center text-sm text-[#06c755] mb-2">
                        <i class="fas fa-spinner fa-spin mr-2"></i>กำลังอัปโหลด...
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="room-form" class="btn-primary flex-1" id="save-room-btn">บันทึก</button>
                <button type="button" class="btn-outline flex-1" onclick="closeRoomModal()">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">แก้ไขโปรไฟล์</h3>
                <button class="modal-close" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form" onsubmit="saveProfile(event)">
                    <input type="text" id="profile-phone" placeholder="เบอร์โทรศัพท์" class="input-field" maxlength="10">
                    <input type="text" id="profile-department" placeholder="แผนก/หน่วยงาน" class="input-field" maxlength="50">
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="profile-form" class="btn-primary flex-1">บันทึก</button>
                <button type="button" class="btn-outline flex-1" onclick="closeProfileModal()">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Role Modal -->
    <div class="modal" id="role-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">จัดการสิทธิ์ผู้ใช้</h3>
                <button class="modal-close" onclick="closeRoleModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="role-form" onsubmit="saveUserRole(event)">
                    <input type="hidden" id="role-user-id">
                    <p id="role-user-name" class="text-white mb-4"></p>
                    <select id="user-role" class="input-field">
                        <option value="user">👤 ผู้ใช้ทั่วไป</option>
                        <option value="manager">👥 ผู้จัดการ</option>
                        <option value="admin">👑 ผู้ดูแลระบบ</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="role-form" class="btn-primary flex-1">บันทึก</button>
                <button type="button" class="btn-outline flex-1" onclick="closeRoleModal()">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIG ==========
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwEkTSINEvnyBdapUWbJ8djVpdLt6rN7NlaXn5cKMow7RJtY3gI19-RSMyFHsWBxII-vA/exec',
            LIFF_ID: '2008904120-nqYHD5BT',
            REQUEST_TIMEOUT: 25000, // 25 seconds
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000
        };

        // ========== STATE ==========
        const state = {
            user: null,
            rooms: [],
            bookings: [],
            myBookings: [],
            pendingBookings: [],
            allBookings: [],
            users: [],
            currentDate: new Date(),
            currentMonth: new Date(),
            selectedDate: new Date(),
            dateBookings: {},
            currentRoom: null,
            currentBooking: null,
            isAdmin: false,
            isManager: false,
            settings: {
                appName: 'Meeting Room',
                requireApproval: 'true',
                reminderMinutes: '30'
            },
            initialized: false,
            requestQueue: new Map(), // ป้องกัน request ซ้ำ
            activeRequests: 0
        };

        // ========== DOM CACHE ==========
        const $ = {
            initLoading: document.getElementById('initial-loading'),
            pageTitle: document.getElementById('page-title'),
            navbarAppName: document.getElementById('navbar-app-name'),
            homeTab: document.getElementById('tab-home'),
            myTab: document.getElementById('tab-my'),
            adminTab: document.getElementById('tab-admin'),
            roomsList: document.getElementById('rooms-list'),
            myBookingsList: document.getElementById('my-bookings-list'),
            pendingBookingsList: document.getElementById('pending-bookings-list'),
            allBookingsList: document.getElementById('all-bookings-list'),
            roomsManagementList: document.getElementById('rooms-management-list'),
            usersList: document.getElementById('users-list'),
            profileName: document.getElementById('profile-name'),
            profileEmail: document.getElementById('profile-email'),
            profileAvatar: document.getElementById('profile-avatar'),
            profileRole: document.getElementById('profile-role'),
            statRooms: document.getElementById('stat-rooms'),
            statToday: document.getElementById('stat-today'),
            statPending: document.getElementById('stat-pending'),
            searchInput: document.getElementById('search-input'),
            navItems: document.querySelectorAll('.nav-item'),
            modal: document.getElementById('room-modal'),
            modalBody: document.getElementById('modal-body'),
            modalTitle: document.getElementById('modal-title'),
            modalBookBtn: document.getElementById('modal-book-btn'),
            modalEditBtn: document.getElementById('modal-edit-btn'),
            modalDeleteBtn: document.getElementById('modal-delete-btn'),
            modalAdminControls: document.getElementById('modal-admin-controls'),
            floatingBtn: document.getElementById('floating-book-btn'),
            quickBookBtn: document.getElementById('quick-book-btn'),
            adminOnly: document.querySelectorAll('.admin-only'),
            refreshAdmin: document.getElementById('refresh-admin'),
            adminUsers: document.getElementById('admin-users'),
            adminRooms: document.getElementById('admin-rooms'),
            adminBookings: document.getElementById('admin-bookings'),
            adminPending: document.getElementById('admin-pending'),
            pendingBadge: document.getElementById('pending-badge'),
            userSearch: document.getElementById('user-search'),
            adminBookingSearch: document.getElementById('admin-booking-search'),
            settingsSaveBtn: document.getElementById('settings-save-btn'),
            settingRequireApproval: document.getElementById('setting-require-approval'),
            settingReminderMinutes: document.getElementById('setting-reminder-minutes'),
            calendarDays: document.getElementById('calendar-days'),
            currentMonth: document.getElementById('current-month'),
            selectedDateBookings: document.getElementById('selected-date-bookings'),
            selectedDateTitle: document.getElementById('selected-date-title'),
            selectedDateBookingsList: document.getElementById('selected-date-bookings-list')
        };

        // ========== UTILS ==========
        function showToast(msg, type = 'success') {
            const colors = {
                success: '#06c755',
                warning: '#f59e0b',
                error: '#ef4444',
                info: '#3b82f6'
            };
            
            const toast = document.getElementById('global-toast');
            if (toast) {
                toast.remove();
            }
            
            const toastEl = document.createElement('div');
            toastEl.id = 'global-toast';
            toastEl.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 16px;
                right: 16px;
                background: #1a1d24;
                border-left: 4px solid ${colors[type] || colors.success};
                border-radius: 12px;
                padding: 12px 16px;
                color: white;
                z-index: 2000;
                max-width: 400px;
                margin: 0 auto;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                animation: slideUp 0.3s ease;
                font-size: 14px;
            `;
            toastEl.textContent = msg;
            document.body.appendChild(toastEl);
            
            setTimeout(() => {
                toastEl.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => toastEl.remove(), 300);
            }, 3000);
        }

        function setButtonLoading(button, isLoading) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.classList.add('loading');
            } else {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        function formatDateThai(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'long'
            });
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric'
            });
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleString('th-TH', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateForInput(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatMonthThai(date) {
            return date.toLocaleDateString('th-TH', { 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function updateAppName(name) {
            if (!name) name = 'Meeting Room';
            $.pageTitle.textContent = name + ' · LINE';
            $.navbarAppName.textContent = name;
        }

        // ========== API CALL พร้อม Retry และ Debounce ==========
        async function callGAS(path, data = {}, options = {}) {
            const {
                retryCount = 0,
                debounceKey = null,
                useCache = false,
                priority = 'normal' // 'high', 'normal', 'low'
            } = options;

            // ป้องกัน request ซ้ำ
            if (debounceKey) {
                if (state.requestQueue.has(debounceKey)) {
                    console.log(`Debouncing ${debounceKey} - request already in progress`);
                    return state.requestQueue.get(debounceKey);
                }
            }

            // จำกัดจำนวน request พร้อมกัน
            if (priority !== 'high' && state.activeRequests >= 3) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            const requestId = debounceKey || `${path}_${Date.now()}`;
            state.activeRequests++;

            const makeRequest = async (retry) => {
                try {
                    const formData = new FormData();
                    formData.append('path', path);
                    
                    // เพิ่ม timestamp เพื่อป้องกัน cache
                    formData.append('_t', Date.now().toString());
                    
                    if (state.user?.lineUserId) {
                        formData.append('lineUserId', state.user.lineUserId);
                    }
                    
                    // แนบข้อมูล
                    Object.keys(data).forEach(key => {
                        if (data[key] !== undefined && data[key] !== null) {
                            // ถ้าเป็นไฟล์ ให้ส่งเป็น Blob
                            if (data[key] instanceof File) {
                                formData.append(key, data[key]);
                            } else {
                                formData.append(key, data[key]);
                            }
                        }
                    });

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);

                    const res = await fetch(CONFIG.GAS_URL, { 
                        method: 'POST', 
                        body: formData,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    
                    const text = await res.text();
                    
                    // ลอง parse JSON
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Invalid JSON response:', text.substring(0, 200));
                        return { 
                            success: false, 
                            message: 'รูปแบบข้อมูลไม่ถูกต้อง',
                            raw: text.substring(0, 200)
                        };
                    }
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง');
                    }
                    throw error;
                }
            };

            try {
                // สร้าง promise และเก็บไว้ใน queue
                const requestPromise = (async () => {
                    let lastError;
                    
                    for (let i = 0; i <= retryCount; i++) {
                        try {
                            if (i > 0) {
                                console.log(`Retry ${i} for ${path}`);
                                await new Promise(resolve => 
                                    setTimeout(resolve, CONFIG.RETRY_DELAY * Math.pow(2, i - 1))
                                );
                            }
                            
                            const result = await makeRequest(i);
                            
                            // ถ้าเจอ lock timeout ให้รอแล้ว retry
                            if (!result.success && 
                                result.message && 
                                result.message.includes('หมดเวลาการล็อก')) {
                                console.log('Lock timeout detected, retrying...');
                                continue;
                            }
                            
                            return result;
                            
                        } catch (error) {
                            console.error(`Request attempt ${i + 1} failed:`, error);
                            lastError = error;
                        }
                    }
                    
                    return { 
                        success: false, 
                        message: lastError?.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ' 
                    };
                })();

                // เก็บไว้ใน queue ถ้ามี debounceKey
                if (debounceKey) {
                    state.requestQueue.set(debounceKey, requestPromise);
                    // ล้าง queue เมื่อเสร็จ
                    requestPromise.finally(() => {
                        state.requestQueue.delete(debounceKey);
                        state.activeRequests--;
                    });
                } else {
                    requestPromise.finally(() => {
                        state.activeRequests--;
                    });
                }

                return await requestPromise;
                
            } catch (error) {
                state.activeRequests--;
                console.error('API Call failed:', error);
                return { 
                    success: false, 
                    message: 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้' 
                };
            }
        }

        // ========== อัปโหลดรูปภาพแบบใหม่ ใช้ FormData โดยตรง ==========
        async function uploadImage(file) {
            if (!file) return null;
            
            // ตรวจสอบขนาดไฟล์ (ไม่เกิน 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('รูปภาพต้องมีขนาดไม่เกิน 2MB', 'error');
                return null;
            }
            
            // ตรวจสอบประเภทไฟล์
            if (!file.type.match(/^image\/(jpeg|png)$/)) {
                showToast('รองรับเฉพาะไฟล์ JPG และ PNG เท่านั้น', 'error');
                return null;
            }

            const progressEl = document.getElementById('upload-progress');
            if (progressEl) progressEl.classList.remove('hidden');

            try {
                // ใช้ callGAS ส่งไฟล์โดยตรง
                const result = await callGAS('uploadImage', {
                    image: file,
                    fileName: file.name
                }, {
                    retryCount: 1,
                    priority: 'high'
                });

                if (result.success) {
                    return result.data?.fileUrl || result.data?.url;
                } else {
                    showToast(result.message || 'อัปโหลดรูปไม่สำเร็จ', 'error');
                    return null;
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast('เกิดข้อผิดพลาดในการอัปโหลด', 'error');
                return null;
            } finally {
                if (progressEl) progressEl.classList.add('hidden');
            }
        }

        window.previewRoomImage = function(input) {
            const preview = document.getElementById('room-image-preview');
            if (input.files?.[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // ========== LIFF INIT ==========
        async function initLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const idToken = liff.getDecodedIDToken();

                // โหลดข้อมูลผู้ใช้ (ไม่ใช้ cache เพราะต้องการข้อมูลล่าสุด)
                const userResult = await callGAS('user/profile', {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    email: idToken?.email || ''
                }, { retryCount: 2, priority: 'high' });

                if (userResult.success) {
                    state.user = userResult.data;
                    state.isAdmin = state.user.role === 'admin';
                    state.isManager = state.isAdmin || state.user.role === 'manager';

                    $.profileName.textContent = state.user.displayName || 'ผู้ใช้';
                    $.profileEmail.textContent = state.user.email || '';
                    $.profileAvatar.src = state.user.pictureUrl || 'https://via.placeholder.com/60/2a2e36/06c755?text=User';
                    $.profileRole.textContent = {
                        admin: '👑 ผู้ดูแลระบบ',
                        manager: '👥 ผู้จัดการ',
                        user: '👤 ผู้ใช้ทั่วไป'
                    }[state.user.role] || '';

                    $.adminOnly.forEach(el => {
                        if (state.isAdmin) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    });

                    if (!state.isAdmin) {
                        $.floatingBtn.classList.remove('hidden');
                        if ($.quickBookBtn) $.quickBookBtn.classList.remove('hidden');
                    }

                    // โหลด settings
                    await loadSettings();
                    
                    // โหลดข้อมูลต่างๆ แบบไม่ต้องรอกัน
                    const loadPromises = [
                        loadRooms().catch(e => console.log('Rooms load error:', e)),
                        loadMyBookings().catch(e => console.log('My bookings load error:', e)),
                        loadTodayStats().catch(e => console.log('Stats load error:', e))
                    ];

                    // โหลดข้อมูลปฏิทิน
                    loadPromises.push(
                        loadMonthBookings(
                            state.currentMonth.getFullYear(), 
                            state.currentMonth.getMonth()
                        ).catch(e => console.log('Calendar load error:', e))
                    );

                    if (state.isManager) {
                        loadPromises.push(
                            loadUsers().catch(e => console.log('Users load error:', e)),
                            loadAdminStats().catch(e => console.log('Admin stats error:', e)),
                            loadPendingBookings().catch(e => console.log('Pending bookings error:', e)),
                            loadAllBookings().catch(e => console.log('All bookings error:', e)),
                            loadRoomsManagement().catch(e => console.log('Rooms management error:', e))
                        );
                    }

                    // รอให้โหลดทั้งหมดเสร็จ (หรือ timeout)
                    await Promise.race([
                        Promise.all(loadPromises),
                        new Promise(resolve => setTimeout(resolve, 5000))
                    ]);

                    $.initLoading.classList.add('hide');
                    state.initialized = true;
                    
                    // เริ่มต้น date pickers
                    initDatePickers();
                }
            } catch (error) {
                console.error('LIFF init error:', error);
                $.initLoading.classList.add('hide');
                showToast('ไม่สามารถเชื่อมต่อ LINE ได้ กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }

        // ========== DATE PICKERS ==========
        function initDatePickers() {
            // ตรวจสอบว่า flatpickr โหลดแล้วหรือยัง
            if (typeof flatpickr === 'undefined') {
                // ถ้ายังไม่โหลด ให้ลองใหม่ภายหลัง
                setTimeout(initDatePickers, 500);
                return;
            }
            
            try {
                flatpickr.localize(flatpickr.l10ns.th);
                
                flatpickr("#booking-date", {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    locale: "th",
                    onChange: function(selectedDates, dateStr) {
                        const endPicker = document.getElementById('booking-end-date')._flatpickr;
                        if (endPicker) endPicker.set('minDate', dateStr);
                        checkAvailability();
                    }
                });
                
                flatpickr("#booking-end-date", {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    locale: "th",
                    onChange: function() {
                        checkAvailability();
                    }
                });
                
                flatpickr("#booking-start", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    time_24hr: true,
                    minuteIncrement: 15,
                    minTime: "08:00",
                    maxTime: "18:00",
                    onChange: function() {
                        checkAvailability();
                    }
                });
                
                flatpickr("#booking-end", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    time_24hr: true,
                    minuteIncrement: 15,
                    minTime: "08:00",
                    maxTime: "19:00",
                    onChange: function() {
                        checkAvailability();
                    }
                });
            } catch (e) {
                console.error('Flatpickr init error:', e);
            }
        }

        // ========== ROOMS ==========
        async function loadRooms() {
            const result = await callGAS('rooms', {}, { 
                debounceKey: 'loadRooms',
                retryCount: 2,
                useCache: true 
            });
            
            if (result.success) {
                state.rooms = result.data || [];
                renderRooms();
            }
            return result;
        }

        function renderRooms() {
            const search = $.searchInput?.value.toLowerCase() || '';
            const filtered = state.rooms.filter(r => 
                r.name?.toLowerCase().includes(search) || 
                r.location?.toLowerCase().includes(search)
            );

            if (!filtered.length) {
                $.roomsList.innerHTML = `
                    <div class="col-span-full text-center py-10 text-gray-400">
                        <i class="fas fa-door-open text-3xl mb-3"></i>
                        <p>ไม่พบห้องประชุม</p>
                        ${state.isAdmin ? '<button class="btn-primary text-sm mt-3" onclick="showCreateRoomModal()"><i class="fas fa-plus mr-1"></i>เพิ่มห้องแรก</button>' : ''}
                    </div>
                `;
                return;
            }

            $.roomsList.innerHTML = filtered.map(r => {
                const imageHtml = r.imageUrl ? 
                    `<img src="${r.imageUrl}" loading="lazy" class="w-full h-full object-cover" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'<i class=\\\'fas fa-door-open text-4xl text-[#06c755]\\\'></i>\';">` : 
                    `<i class="fas fa-door-open text-4xl text-[#06c755]"></i>`;
                
                return `
                <div class="room-card" onclick="showRoomDetail('${r.roomId}')">
                    <div class="room-image">
                        ${imageHtml}
                    </div>
                    <div class="room-content">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-base">${r.name}</h3>
                            <span class="capacity-badge"><i class="fas fa-users mr-1"></i>${r.capacity}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${r.location || 'ไม่มีข้อมูล'}</p>
                        <p class="text-xs text-gray-500 line-clamp-2 mb-3">${r.description || ''}</p>
                        <div class="flex justify-between items-center">
                            <span class="badge badge-available">ว่าง</span>
                            <button class="text-[#06c755] text-sm" onclick="showBookingModal('${r.roomId}'); event.stopPropagation();">
                                <i class="fas fa-calendar-plus mr-1"></i>จอง
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // ========== ROOMS MANAGEMENT ==========
        async function loadRoomsManagement() {
            const result = await callGAS('rooms', {}, { debounceKey: 'loadRoomsManagement' });
            
            if (result.success) {
                const rooms = result.data || [];
                renderRoomsManagement(rooms);
            }
        }

        function renderRoomsManagement(rooms) {
            if (!rooms.length) {
                $.roomsManagementList.innerHTML = '<p class="text-center text-gray-400 py-6">ไม่มีห้องประชุม</p>';
                return;
            }

            $.roomsManagementList.innerHTML = rooms.map(room => `
                <div class="room-management-item">
                    <div class="room-management-info">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold">${room.name}</span>
                            <span class="capacity-badge text-xs"><i class="fas fa-users mr-1"></i>${room.capacity}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${room.location || 'ไม่มีสถานที่'}</p>
                    </div>
                    <div class="room-management-actions">
                        <button class="text-[#06c755] text-sm" onclick="editRoom('${room.roomId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-500 text-sm" onclick="deleteRoom('${room.roomId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.editRoom = function(roomId) {
            const room = state.rooms.find(r => r.roomId === roomId);
            if (room) {
                state.currentRoom = room;
                editCurrentRoom();
            }
        };

        window.deleteRoom = async function(roomId) {
            const room = state.rooms.find(r => r.roomId === roomId);
            if (room) {
                state.currentRoom = room;
                deleteCurrentRoom();
            }
        };

        window.showRoomDetail = async function(roomId) {
            $.modal.classList.add('active');
            $.modalBody.innerHTML = '<div class="flex justify-center py-10"><div class="loading-spinner w-10 h-10"></div></div>';
            
            const result = await callGAS('room', { roomId }, { debounceKey: `room_${roomId}` });
            
            if (result.success) {
                const room = result.data;
                state.currentRoom = room;
                $.modalTitle.textContent = room.name;

                const facilities = room.facilities ? room.facilities.split(',').map(f => f.trim()) : [];

                const today = new Date();
                const dateStr = formatDateForInput(today);
                const bookingsResult = await callGAS('bookings', { 
                    roomId, 
                    date: dateStr,
                    showPast: 'false'
                }, { debounceKey: `bookings_${roomId}_${dateStr}` });
                
                const todayBookings = bookingsResult.success ? bookingsResult.data.bookings : [];

                const imageHtml = room.imageUrl ? 
                    `<img src="${room.imageUrl}" class="w-full max-h-80 object-cover rounded-xl mb-4" loading="lazy" onerror="this.style.display=\'none\';">` : 
                    `<div class="w-full h-48 flex items-center justify-center bg-gradient-to-br from-[#2a2e36] to-[#1a1d24] rounded-xl mb-4">
                        <i class="fas fa-door-open text-6xl text-[#06c755]"></i>
                    </div>`;

                $.modalBody.innerHTML = `
                    ${imageHtml}
                    <div class="flex gap-2 mb-4 flex-wrap">
                        <span class="capacity-badge"><i class="fas fa-users mr-1"></i> รองรับ ${room.capacity} คน</span>
                        <span class="badge badge-available">พร้อมใช้งาน</span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-1"><i class="fas fa-map-marker-alt mr-2"></i> สถานที่</p>
                        <p class="mb-3">${room.location || 'ไม่มีข้อมูล'}</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-1"><i class="fas fa-info-circle mr-2"></i> รายละเอียด</p>
                        <p class="whitespace-pre-wrap">${room.description || 'ไม่มีรายละเอียด'}</p>
                    </div>
                    
                    ${facilities.length > 0 ? `
                        <div class="mb-4">
                            <p class="text-sm text-gray-400 mb-2"><i class="fas fa-couch mr-2"></i> สิ่งอำนวยความสะดวก</p>
                            <div>
                                ${facilities.map(f => `<span class="facility-tag">${f}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${todayBookings.length > 0 ? `
                        <div class="mt-4 pt-4 border-t border-[#2a2e36]">
                            <p class="text-sm text-gray-400 mb-2"><i class="fas fa-clock mr-2"></i> การจองวันนี้</p>
                            <div class="space-y-2">
                                ${todayBookings.map(b => {
                                    const statusColor = {
                                        'confirmed': 'text-green-500',
                                        'pending': 'text-yellow-500',
                                        'cancelled': 'text-gray-500',
                                        'rejected': 'text-red-500'
                                    }[b.status] || 'text-gray-500';
                                    
                                    return `
                                        <div class="bg-[#111317] p-2 rounded-lg text-sm">
                                            <div class="flex justify-between">
                                                <span class="font-semibold">${formatTime(b.startTime)} - ${formatTime(b.endTime)}</span>
                                                <span class="${statusColor}">${b.status === 'confirmed' ? 'จองแล้ว' : b.status}</span>
                                            </div>
                                            <p class="text-xs text-gray-400">${b.title}</p>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                $.modalBookBtn.onclick = () => showBookingModal(roomId);

                if (state.isAdmin) {
                    $.modalAdminControls.classList.remove('hidden');
                    $.modalEditBtn.disabled = false;
                    $.modalDeleteBtn.disabled = false;
                } else {
                    $.modalAdminControls.classList.add('hidden');
                }
            }
        };

        window.closeModal = function() {
            $.modal.classList.remove('active');
            state.currentRoom = null;
        };

        // ========== BOOKINGS ==========
        window.showBookingModal = function(roomId = null) {
            document.getElementById('booking-modal-title').textContent = 'จองห้องประชุม';
            document.getElementById('edit-booking-id').value = '';
            document.getElementById('booking-title').value = '';
            document.getElementById('booking-description').value = '';
            document.getElementById('booking-meeting-link').value = '';
            document.getElementById('booking-attendees').value = '4';
            document.getElementById('availability-status').classList.add('hidden');
            document.getElementById('save-booking-btn').disabled = false;
            
            const roomSelect = document.getElementById('booking-room');
            roomSelect.innerHTML = '<option value="">เลือกห้องประชุม</option>';
            state.rooms.forEach(r => {
                const option = document.createElement('option');
                option.value = r.roomId;
                option.textContent = `${r.name} (${r.capacity} ที่นั่ง)`;
                if (r.roomId === roomId) option.selected = true;
                roomSelect.appendChild(option);
            });
            
            const now = new Date();
            const nextHour = new Date(now);
            nextHour.setHours(now.getHours() + 1, 0, 0, 0);
            
            const endTime = new Date(nextHour);
            endTime.setHours(nextHour.getHours() + 1, 0, 0, 0);
            
            document.getElementById('booking-date').value = formatDateForInput(nextHour);
            document.getElementById('booking-end-date').value = formatDateForInput(nextHour);
            document.getElementById('booking-start').value = nextHour.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('booking-end').value = endTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('booking-create-modal').classList.add('active');
            
            // Check availability after modal opens
            setTimeout(checkAvailability, 500);
        };

        window.closeBookingCreateModal = function() {
            document.getElementById('booking-create-modal').classList.remove('active');
        };

        async function checkAvailability() {
            const roomId = document.getElementById('booking-room').value;
            const startDate = document.getElementById('booking-date').value;
            const endDate = document.getElementById('booking-end-date').value;
            const start = document.getElementById('booking-start').value;
            const end = document.getElementById('booking-end').value;
            
            if (!roomId || !startDate || !endDate || !start || !end) return;
            
            const startDateTime = new Date(`${startDate}T${start}:00`);
            const endDateTime = new Date(`${endDate}T${end}:00`);
            
            if (startDateTime >= endDateTime) {
                document.getElementById('availability-status').innerHTML = '<span class="text-red-500">⚠️ เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม</span>';
                document.getElementById('availability-status').classList.remove('hidden');
                document.getElementById('save-booking-btn').disabled = true;
                return;
            }
            
            const startHour = startDateTime.getHours();
            const endHour = endDateTime.getHours();
            if (startHour < 8 || endHour > 20 || (endHour === 20 && endDateTime.getMinutes() > 0)) {
                document.getElementById('availability-status').innerHTML = '<span class="text-red-500">⚠️ เวลาทำการ 08:00 - 20:00 น.</span>';
                document.getElementById('availability-status').classList.remove('hidden');
                document.getElementById('save-booking-btn').disabled = true;
                return;
            }
            
            const durationHours = (endDateTime - startDateTime) / (1000 * 60 * 60);
            if (durationHours > 24) {
                document.getElementById('availability-status').innerHTML = '<span class="text-red-500">⚠️ จองได้ครั้งละไม่เกิน 24 ชั่วโมง</span>';
                document.getElementById('availability-status').classList.remove('hidden');
                document.getElementById('save-booking-btn').disabled = true;
                return;
            }
            
            const result = await callGAS('booking/check-availability', {
                roomId,
                startTime: startDateTime.toISOString(),
                endTime: endDateTime.toISOString()
            }, { debounceKey: `check_avail_${roomId}_${startDateTime.getTime()}` });
            
            if (result.success) {
                if (result.data.available) {
                    document.getElementById('availability-status').innerHTML = '<span class="text-green-500">✅ ห้องว่างในช่วงเวลาที่เลือก</span>';
                    document.getElementById('availability-status').classList.remove('hidden');
                    document.getElementById('save-booking-btn').disabled = false;
                } else {
                    let message = '❌ ห้องไม่ว่างในช่วงเวลาที่เลือก';
                    if (result.data.conflictingBookings && result.data.conflictingBookings.length > 0) {
                        const times = result.data.conflictingBookings.map(c => 
                            `${formatTime(c.startTime)}-${formatTime(c.endTime)}`
                        ).join(', ');
                        message = `❌ มีการจองแล้วในช่วงเวลา: ${times}`;
                    }
                    document.getElementById('availability-status').innerHTML = `<span class="text-red-500">${message}</span>`;
                    document.getElementById('availability-status').classList.remove('hidden');
                    document.getElementById('save-booking-btn').disabled = true;
                }
            }
        }

        // ========== FLEX MESSAGE ==========
        function createBookingFlexMessage(booking) {
            const startTime = new Date(booking.startTime);
            const endTime = new Date(booking.endTime);
            const dateStr = startTime.toLocaleDateString('th-TH', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = startTime.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) + ' - ' + 
            endTime.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) + ' น.';
            
            const statusColor = booking.status === 'confirmed' ? '#06c755' : '#f59e0b';
            const statusText = booking.status === 'confirmed' ? '✅ อนุมัติแล้ว' : '⏳ รออนุมัติ';

            return {
                type: 'flex',
                altText: `📅 การจอง: ${booking.title}`,
                contents: {
                    type: 'bubble',
                    header: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: '📅 รายละเอียดการจอง',
                                weight: 'bold',
                                size: 'xl',
                                color: '#06c755'
                            }
                        ]
                    },
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: booking.roomName,
                                weight: 'bold',
                                size: 'lg',
                                wrap: true
                            },
                            {
                                type: 'text',
                                text: booking.title,
                                size: 'md',
                                color: '#666666',
                                wrap: true,
                                margin: 'md'
                            },
                            {
                                type: 'separator',
                                margin: 'lg'
                            },
                            {
                                type: 'box',
                                layout: 'vertical',
                                margin: 'lg',
                                contents: [
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: '📅 วันที่',
                                                size: 'sm',
                                                color: '#aaaaaa',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: dateStr,
                                                size: 'sm',
                                                flex: 5,
                                                wrap: true
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        margin: 'md',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: '⏰ เวลา',
                                                size: 'sm',
                                                color: '#aaaaaa',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: timeStr,
                                                size: 'sm',
                                                flex: 5
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        margin: 'md',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: '👥 ผู้เข้าร่วม',
                                                size: 'sm',
                                                color: '#aaaaaa',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: booking.attendees + ' คน',
                                                size: 'sm',
                                                flex: 5
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        margin: 'md',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: '📌 สถานะ',
                                                size: 'sm',
                                                color: '#aaaaaa',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: statusText,
                                                size: 'sm',
                                                color: statusColor,
                                                flex: 5
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                type: 'separator',
                                margin: 'lg'
                            },
                            {
                                type: 'text',
                                text: '👤 ผู้จอง: ' + booking.userName,
                                size: 'sm',
                                color: '#888888',
                                margin: 'lg'
                            }
                        ]
                    }
                }
            };
        }

        async function sendBookingToChat(bookingData) {
            try {
                if (!liff.isInClient()) {
                    console.log('Not in LINE client, cannot send message');
                    return false;
                }

                const flexMessage = createBookingFlexMessage(bookingData);
                await liff.sendMessages([flexMessage]);
                console.log('Flex message sent successfully');
                showToast('ส่งข้อมูลการจองไปยังแชทแล้ว');
                return true;
            } catch (error) {
                console.error('Error sending flex message:', error);
                return false;
            }
        }

        window.shareBookingViaPicker = async function(bookingId) {
            try {
                if (!liff.isInClient()) {
                    showToast('กรุณาเปิดใน LINE', 'warning');
                    return;
                }

                const result = await callGAS('booking', { bookingId });
                if (!result.success) {
                    showToast('ไม่พบข้อมูลการจอง', 'error');
                    return;
                }

                const booking = result.data;
                const flexMessage = createBookingFlexMessage(booking);

                await liff.shareTargetPicker([flexMessage]);
                showToast('แชร์การจองสำเร็จ');
                
            } catch (error) {
                console.error('Share via picker error:', error);
                showToast('ไม่สามารถแชร์ได้', 'error');
            }
        };

        window.saveBooking = async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('save-booking-btn');
            if (btn.disabled) return;
            
            setButtonLoading(btn, true);

            try {
                const id = document.getElementById('edit-booking-id').value;
                const roomId = document.getElementById('booking-room').value;
                const startDate = document.getElementById('booking-date').value;
                const endDate = document.getElementById('booking-end-date').value;
                const start = document.getElementById('booking-start').value;
                const end = document.getElementById('booking-end').value;
                
                const startDateTime = new Date(`${startDate}T${start}:00`);
                const endDateTime = new Date(`${endDate}T${end}:00`);
                
                const data = {
                    roomId,
                    title: document.getElementById('booking-title').value,
                    description: document.getElementById('booking-description').value,
                    meetingLink: document.getElementById('booking-meeting-link').value,
                    startTime: startDateTime.toISOString(),
                    endTime: endDateTime.toISOString(),
                    attendees: document.getElementById('booking-attendees').value,
                    userName: state.user.displayName,
                    lineUserId: state.user.lineUserId
                };

                if (id) data.bookingId = id;

                const result = await callGAS(id ? 'booking/update' : 'booking/create', data, { 
                    retryCount: 2,
                    priority: 'high'
                });

                if (result.success) {
                    showToast(id ? 'แก้ไขการจองสำเร็จ' : 'จองห้องสำเร็จ');
                    
                    closeBookingCreateModal();
                    
                    // โหลดข้อมูลใหม่แบบไม่ต้องรอ
                    Promise.all([
                        loadRooms(), 
                        loadMyBookings(), 
                        loadTodayStats(),
                        loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth())
                    ]).catch(e => console.log('Reload after booking error:', e));
                    
                    // Send to chat for new bookings
                    if (!id && result.data?.bookingData && liff.isInClient()) {
                        setTimeout(async () => {
                            await sendBookingToChat(result.data.bookingData);
                        }, 500);
                    }
                } else {
                    showToast(result.message || 'เกิดข้อผิดพลาด', 'error');
                }
            } catch (error) {
                console.error('Save booking error:', error);
                showToast('เกิดข้อผิดพลาด', 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        };

        // ========== MY BOOKINGS ==========
        async function loadMyBookings() {
            const result = await callGAS('user/bookings', {
                lineUserId: state.user?.lineUserId
            }, { debounceKey: 'myBookings' });

            if (result.success) {
                state.myBookings = result.data || [];
                renderMyBookings('all');
            }
        }

        function renderMyBookings(filter = 'all') {
            let filtered = state.myBookings;
            
            if (filter !== 'all') {
                filtered = filtered.filter(b => b.status === filter);
            }

            const now = new Date();
            filtered = filtered.filter(b => {
                if (b.status === 'pending') return true;
                const endTime = new Date(b.endTime);
                return endTime >= now;
            });

            if (!filtered.length) {
                $.myBookingsList.innerHTML = `
                    <div class="col-span-full text-center py-10 text-gray-400">
                        <i class="fas fa-calendar-times text-3xl mb-3"></i>
                        <p>ไม่พบการจอง</p>
                        <button class="btn-primary text-sm mt-3" onclick="showBookingModal()">
                            <i class="fas fa-plus mr-1"></i>จองห้องแรก
                        </button>
                    </div>
                `;
                return;
            }

            $.myBookingsList.innerHTML = filtered.map(b => {
                const statusClass = {
                    'confirmed': 'badge-confirmed',
                    'pending': 'badge-pending',
                    'cancelled': 'badge-cancelled',
                    'rejected': 'badge-rejected'
                }[b.status] || 'badge-pending';
                
                const statusText = {
                    'confirmed': 'อนุมัติแล้ว',
                    'pending': 'รออนุมัติ',
                    'cancelled': 'ยกเลิก',
                    'rejected': 'ปฏิเสธ'
                }[b.status] || b.status;
                
                return `
                <div class="bg-[#1a1d24] p-4 rounded-xl border border-[#2a2e36] cursor-pointer" onclick="showBookingDetail('${b.bookingId}')">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold">${b.title}</h3>
                        <span class="badge ${statusClass}">${statusText}</span>
                    </div>
                    <p class="text-sm text-[#06c755] mb-2">${b.roomName}</p>
                    <p class="text-xs text-gray-400 mb-2">
                        <i class="far fa-calendar mr-1"></i> ${formatDateShort(b.startTime)} - ${formatDateShort(b.endTime)}<br>
                        <i class="far fa-clock mr-1"></i> ${formatTime(b.startTime)} - ${formatTime(b.endTime)}
                    </p>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500"><i class="fas fa-users mr-1"></i> ${b.attendees || 0} คน</span>
                        ${b.meetingLink ? '<span class="text-blue-500"><i class="fas fa-video mr-1"></i> มีลิงค์</span>' : ''}
                        ${b.status === 'confirmed' && b.userId === state.user?.lineUserId ? `
                            <button class="text-red-500" onclick="cancelBooking('${b.bookingId}'); event.stopPropagation();">
                                <i class="fas fa-times mr-1"></i>ยกเลิก
                            </button>
                        ` : ''}
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button class="text-xs text-[#06c755]" onclick="shareBookingViaPicker('${b.bookingId}'); event.stopPropagation();">
                            <i class="fas fa-share-alt mr-1"></i>แชร์
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        window.showBookingDetail = async function(bookingId) {
            document.getElementById('booking-modal').classList.add('active');
            document.getElementById('booking-modal-body').innerHTML = '<div class="flex justify-center py-10"><div class="loading-spinner w-10 h-10"></div></div>';
            
            const result = await callGAS('booking', { bookingId }, { debounceKey: `booking_${bookingId}` });
            
            if (result.success) {
                const b = result.data;
                state.currentBooking = b;
                
                const statusClass = {
                    'confirmed': 'badge-confirmed',
                    'pending': 'badge-pending',
                    'cancelled': 'badge-cancelled',
                    'rejected': 'badge-rejected'
                }[b.status] || 'badge-pending';
                
                const statusText = {
                    'confirmed': 'อนุมัติแล้ว',
                    'pending': 'รออนุมัติ',
                    'cancelled': 'ยกเลิก',
                    'rejected': 'ปฏิเสธ'
                }[b.status] || b.status;

                document.getElementById('booking-modal-body').innerHTML = `
                    <div class="mb-4">
                        <span class="badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-1">หัวข้อ</p>
                        <p class="text-lg font-semibold">${b.title}</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-1">ห้องประชุม</p>
                        <p class="text-[#06c755]">${b.roomName}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">วันที่เริ่ม</p>
                            <p>${formatDateShort(b.startTime)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400 mb-1">วันที่สิ้นสุด</p>
                            <p>${formatDateShort(b.endTime)}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">เวลาเริ่ม</p>
                            <p>${formatTime(b.startTime)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400 mb-1">เวลาสิ้นสุด</p>
                            <p>${formatTime(b.endTime)}</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-1">จำนวนผู้เข้าร่วม</p>
                        <p>${b.attendees || 0} คน</p>
                    </div>
                    
                    ${b.meetingLink ? `
                        <div class="mb-4">
                            <p class="text-sm text-gray-400 mb-1">ลิงค์ประชุม</p>
                            <a href="${b.meetingLink}" target="_blank" class="text-[#06c755] underline break-all">${b.meetingLink}</a>
                        </div>
                    ` : ''}
                    
                    ${b.description ? `
                        <div class="mb-4">
                            <p class="text-sm text-gray-400 mb-1">รายละเอียด</p>
                            <p class="whitespace-pre-wrap">${b.description}</p>
                        </div>
                    ` : ''}
                    
                    <div class="text-xs text-gray-500 border-t border-[#2a2e36] pt-3">
                        <p>จองโดย: ${b.userName}</p>
                        <p class="mt-1">${formatDateTime(b.createdAt)}</p>
                    </div>
                `;

                const footer = document.getElementById('booking-modal-footer');
                const now = new Date();
                const endTime = new Date(b.endTime);
                const canCancel = b.status === 'confirmed' && endTime > now && b.userId === state.user?.lineUserId;
                
                footer.innerHTML = `
                    ${canCancel ? `
                        <button class="btn-danger flex-1" onclick="cancelBooking('${b.bookingId}')">
                            <i class="fas fa-times mr-2"></i>ยกเลิก
                        </button>
                    ` : ''}
                    <button class="btn-outline flex-1" onclick="shareBookingViaPicker('${b.bookingId}')">
                        <i class="fas fa-share-alt mr-2"></i>แชร์
                    </button>
                    <button class="btn-outline flex-1" onclick="closeBookingDetailModal()">ปิด</button>
                `;
            }
        };

        window.closeBookingDetailModal = function() {
            document.getElementById('booking-modal').classList.remove('active');
            state.currentBooking = null;
        };

        window.cancelBooking = async function(bookingId) {
            const result = await Swal.fire({
                title: 'ยกเลิกการจอง',
                text: 'คุณแน่ใจหรือไม่ว่าต้องการยกเลิกการจองนี้?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ใช่, ยกเลิก',
                cancelButtonText: 'ปิด'
            });

            if (result.isConfirmed) {
                const apiResult = await callGAS('booking/cancel', { 
                    bookingId,
                    lineUserId: state.user.lineUserId
                }, { priority: 'high' });

                if (apiResult.success) {
                    showToast('ยกเลิกการจองสำเร็จ');
                    closeBookingDetailModal();
                    await Promise.all([
                        loadMyBookings(), 
                        loadRooms(), 
                        loadTodayStats(),
                        loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth())
                    ]);
                } else {
                    showToast(apiResult.message || 'ยกเลิกไม่สำเร็จ', 'error');
                }
            }
        };

        // ========== ADMIN FUNCTIONS ==========
        async function loadAdminStats() {
            const result = await callGAS('admin/stats', {}, { debounceKey: 'adminStats' });
            if (result.success) {
                $.adminUsers.textContent = result.data.users || 0;
                $.adminRooms.textContent = result.data.rooms || 0;
                $.adminBookings.textContent = result.data.bookings || 0;
                $.adminPending.textContent = result.data.pending || 0;
            }
        }

        async function loadTodayStats() {
            const result = await callGAS('admin/stats', {}, { debounceKey: 'todayStats' });
            if (result.success) {
                $.statRooms.textContent = result.data.rooms || 0;
                $.statToday.textContent = result.data.today || 0;
                $.statPending.textContent = result.data.pending || 0;
            }
        }

        async function loadPendingBookings() {
            const result = await callGAS('admin/pending-bookings', {}, { debounceKey: 'pendingBookings' });
            if (result.success) {
                state.pendingBookings = result.data || [];
                renderPendingBookings();
                
                const count = state.pendingBookings.length;
                if (count > 0 && $.pendingBadge) {
                    $.pendingBadge.textContent = count > 9 ? '9+' : count;
                    $.pendingBadge.classList.remove('hidden');
                } else if ($.pendingBadge) {
                    $.pendingBadge.classList.add('hidden');
                }
            }
        }

        function renderPendingBookings() {
            if (!state.pendingBookings.length) {
                $.pendingBookingsList.innerHTML = '<div class="text-center py-10 text-gray-400">ไม่มีรายการรออนุมัติ</div>';
                return;
            }

            $.pendingBookingsList.innerHTML = state.pendingBookings.map(b => `
                <div class="bg-[#1a1d24] p-4 rounded-xl border border-yellow-500/30">
                    <div class="flex justify-between mb-2">
                        <span class="badge badge-pending">⏳ รออนุมัติ</span>
                        <span class="text-xs text-gray-500">${formatDateTime(b.createdAt)}</span>
                    </div>
                    <h3 class="font-semibold mb-1">${b.title}</h3>
                    <p class="text-sm text-[#06c755] mb-2">${b.roomName}</p>
                    <p class="text-xs text-gray-400 mb-3">
                        <i class="far fa-calendar mr-1"></i> ${formatDateShort(b.startTime)} - ${formatDateShort(b.endTime)}<br>
                        <i class="far fa-clock mr-1"></i> ${formatTime(b.startTime)} - ${formatTime(b.endTime)}
                    </p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">โดย: ${b.userName}</span>
                        <div class="flex gap-2">
                            <button class="btn-success text-xs py-2 px-3" onclick="approveBooking('${b.bookingId}', this)">อนุมัติ</button>
                            <button class="btn-danger text-xs py-2 px-3" onclick="rejectBooking('${b.bookingId}', this)">ปฏิเสธ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.approveBooking = async function(bookingId, btn) {
            setButtonLoading(btn, true);
            
            const result = await callGAS('booking/approve', { bookingId }, { priority: 'high' });
            
            if (result.success) {
                showToast('อนุมัติการจองสำเร็จ');
                await Promise.all([
                    loadPendingBookings(), 
                    loadAdminStats(), 
                    loadTodayStats(),
                    loadAllBookings(),
                    loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth())
                ]);
            } else {
                showToast(result.message || 'อนุมัติไม่สำเร็จ', 'error');
            }
            
            setButtonLoading(btn, false);
        };

        window.rejectBooking = async function(bookingId, btn) {
            setButtonLoading(btn, true);
            
            const result = await Swal.fire({
                title: 'ปฏิเสธการจอง',
                input: 'textarea',
                inputLabel: 'เหตุผลที่ปฏิเสธ',
                inputPlaceholder: 'ระบุเหตุผล...',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ปฏิเสธ',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                const apiResult = await callGAS('booking/reject', { 
                    bookingId,
                    reason: result.value || 'ไม่ระบุเหตุผล'
                }, { priority: 'high' });
                
                if (apiResult.success) {
                    showToast('ปฏิเสธการจองสำเร็จ');
                    await Promise.all([
                        loadPendingBookings(), 
                        loadAdminStats(), 
                        loadTodayStats(),
                        loadAllBookings(),
                        loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth())
                    ]);
                } else {
                    showToast(apiResult.message || 'ปฏิเสธไม่สำเร็จ', 'error');
                }
            }
            
            setButtonLoading(btn, false);
        };

        async function loadAllBookings() {
            const result = await callGAS('admin/all-bookings', {}, { debounceKey: 'allBookings' });
            if (result.success) {
                state.allBookings = result.data || [];
                renderAllBookings();
            }
        }

        function renderAllBookings() {
            const search = $.adminBookingSearch?.value.toLowerCase() || '';
            const filtered = state.allBookings.filter(b => 
                b.title?.toLowerCase().includes(search) || 
                b.userName?.toLowerCase().includes(search) ||
                b.roomName?.toLowerCase().includes(search)
            );

            if (!filtered.length) {
                $.allBookingsList.innerHTML = '<p class="text-center text-gray-400 py-6">ไม่พบการจอง</p>';
                return;
            }

            $.allBookingsList.innerHTML = filtered.map(b => {
                const statusClass = {
                    'confirmed': 'badge-confirmed',
                    'pending': 'badge-pending',
                    'cancelled': 'badge-cancelled',
                    'rejected': 'badge-rejected'
                }[b.status] || 'badge-pending';
                
                return `
                <div class="bg-[#1a1d24] p-3 rounded-lg border border-[#2a2e36]">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-semibold text-sm">${b.title}</span>
                            <span class="text-xs text-gray-400 ml-2">${b.roomName}</span>
                        </div>
                        <span class="badge ${statusClass} text-xs">${b.status}</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span><i class="far fa-user mr-1"></i> ${b.userName}</span>
                        <span><i class="far fa-clock mr-1"></i> ${formatDateShort(b.startTime)} - ${formatDateShort(b.endTime)}</span>
                    </div>
                </div>
            `}).join('');
        }

        async function loadUsers() {
            const result = await callGAS('admin/users', {}, { debounceKey: 'users' });
            if (result.success) {
                state.users = result.data || [];
                renderUsers();
            }
        }

        function renderUsers() {
            const search = $.userSearch?.value.toLowerCase() || '';
            const filtered = state.users.filter(u => 
                u.displayName?.toLowerCase().includes(search) || 
                u.email?.toLowerCase().includes(search)
            );

            if (!filtered.length) {
                $.usersList.innerHTML = '<p class="text-center text-gray-400 py-6">ไม่พบผู้ใช้</p>';
                return;
            }

            $.usersList.innerHTML = filtered.map(u => `
                <div class="user-row">
                    <img src="${u.pictureUrl || 'https://via.placeholder.com/40/2a2e36/06c755?text=User'}" class="user-avatar-sm" loading="lazy">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-sm truncate">${u.displayName || ''}</p>
                        <p class="text-xs text-gray-400 truncate">${u.email || ''}</p>
                    </div>
                    <span class="role-badge role-${u.role}">${{admin:'ผู้ดูแล', manager:'ผู้จัดการ', user:'ผู้ใช้'}[u.role] || u.role}</span>
                    ${state.isAdmin ? `
                        <button class="text-[#06c755] text-xs flex-shrink-0" onclick="showRoleModal('${u.lineUserId}', '${u.displayName}', '${u.role}')">
                            <i class="fas fa-cog"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        window.showRoleModal = function(userId, userName, currentRole) {
            document.getElementById('role-user-id').value = userId;
            document.getElementById('role-user-name').textContent = `จัดการสิทธิ์: ${userName}`;
            document.getElementById('user-role').value = currentRole;
            document.getElementById('role-modal').classList.add('active');
        };

        window.closeRoleModal = function() {
            document.getElementById('role-modal').classList.remove('active');
        };

        window.saveUserRole = async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('role-user-id').value;
            const role = document.getElementById('user-role').value;

            const saveBtn = e.submitter;
            setButtonLoading(saveBtn, true);

            const result = await callGAS('admin/user/role', {
                targetUserId: userId,
                role,
                lineUserId: state.user.lineUserId
            }, { priority: 'high' });

            if (result.success) {
                showToast('อัปเดตสิทธิ์สำเร็จ');
                closeRoleModal();
                await loadUsers();
                
                if (userId === state.user?.lineUserId) {
                    const userResult = await callGAS('user/profile', {
                        lineUserId: state.user.lineUserId
                    }, { priority: 'high' });
                    
                    if (userResult.success) {
                        state.user = userResult.data;
                        state.isAdmin = state.user.role === 'admin';
                        state.isManager = state.isAdmin || state.user.role === 'manager';
                        
                        $.profileRole.textContent = {
                            admin: '👑 ผู้ดูแลระบบ',
                            manager: '👥 ผู้จัดการ',
                            user: '👤 ผู้ใช้ทั่วไป'
                        }[state.user.role] || '';
                        
                        $.adminOnly.forEach(el => {
                            if (state.isAdmin) el.classList.remove('hidden');
                            else el.classList.add('hidden');
                        });
                    }
                }
            } else {
                showToast(result.message || 'อัปเดตไม่สำเร็จ', 'error');
            }

            setButtonLoading(saveBtn, false);
        };

        // ========== ROOM MANAGEMENT ==========
        window.showCreateRoomModal = function() {
            document.getElementById('room-modal-title').textContent = 'เพิ่มห้องใหม่';
            document.getElementById('edit-room-id').value = '';
            document.getElementById('room-name').value = '';
            document.getElementById('room-capacity').value = '';
            document.getElementById('room-location').value = '';
            document.getElementById('room-description').value = '';
            document.getElementById('room-facilities').value = '';
            document.getElementById('room-image').value = '';
            document.getElementById('room-image-preview').style.display = 'none';
            document.getElementById('room-create-modal').classList.add('active');
        };

        window.closeRoomModal = function() {
            document.getElementById('room-create-modal').classList.remove('active');
        };

        window.saveRoom = async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('save-room-btn');
            if (btn.disabled) return;
            
            setButtonLoading(btn, true);

            try {
                const id = document.getElementById('edit-room-id').value;
                let imageUrl = document.getElementById('room-image').value;
                const file = document.getElementById('room-image-file').files[0];

                // อัปโหลดรูปภาพ (ถ้ามี)
                if (file) {
                    const uploaded = await uploadImage(file);
                    if (uploaded) {
                        imageUrl = uploaded;
                    } else {
                        setButtonLoading(btn, false);
                        return; // หยุดถ้าอัปโหลดไม่สำเร็จ
                    }
                }

                const data = {
                    name: document.getElementById('room-name').value,
                    capacity: document.getElementById('room-capacity').value,
                    location: document.getElementById('room-location').value,
                    description: document.getElementById('room-description').value,
                    facilities: document.getElementById('room-facilities').value,
                    imageUrl,
                    lineUserId: state.user.lineUserId
                };

                if (id) data.roomId = id;

                const result = await callGAS(id ? 'room/update' : 'room/create', data, { 
                    retryCount: 2,
                    priority: 'high'
                });

                if (result.success) {
                    showToast(id ? 'แก้ไขห้องสำเร็จ' : 'เพิ่มห้องสำเร็จ');
                    closeRoomModal();
                    
                    // โหลดข้อมูลใหม่
                    await Promise.all([
                        loadRooms(),
                        loadRoomsManagement(),
                        state.isAdmin ? loadAdminStats() : Promise.resolve()
                    ]);
                } else {
                    showToast(result.message || 'เกิดข้อผิดพลาด', 'error');
                }
            } catch (error) {
                console.error('Save room error:', error);
                showToast('เกิดข้อผิดพลาด', 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        };

        window.editCurrentRoom = function() {
            if (!state.currentRoom) return;
            
            const r = state.currentRoom;
            document.getElementById('room-modal-title').textContent = 'แก้ไขห้อง';
            document.getElementById('edit-room-id').value = r.roomId;
            document.getElementById('room-name').value = r.name;
            document.getElementById('room-capacity').value = r.capacity;
            document.getElementById('room-location').value = r.location;
            document.getElementById('room-description').value = r.description || '';
            document.getElementById('room-facilities').value = r.facilities || '';
            document.getElementById('room-image').value = r.imageUrl || '';
            
            if (r.imageUrl) {
                document.getElementById('room-image-preview').src = r.imageUrl;
                document.getElementById('room-image-preview').style.display = 'block';
            }
            
            closeModal();
            document.getElementById('room-create-modal').classList.add('active');
        };

        window.deleteCurrentRoom = async function() {
            if (!state.currentRoom) return;

            const result = await Swal.fire({
                title: 'ลบห้องประชุม',
                text: 'คุณแน่ใจหรือไม่? การลบห้องจะส่งผลต่อการจองที่เกี่ยวข้อง',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ใช่, ลบ'
            });

            if (result.isConfirmed) {
                const deleteBtn = $.modalDeleteBtn;
                setButtonLoading(deleteBtn, true);

                const apiResult = await callGAS('room/delete', { 
                    roomId: state.currentRoom.roomId,
                    lineUserId: state.user.lineUserId
                }, { priority: 'high' });

                if (apiResult.success) {
                    showToast('ลบห้องสำเร็จ');
                    closeModal();
                    await Promise.all([
                        loadRooms(),
                        loadRoomsManagement(),
                        loadAdminStats()
                    ]);
                } else {
                    showToast(apiResult.message || 'ลบไม่สำเร็จ', 'error');
                }

                setButtonLoading(deleteBtn, false);
            }
        };

        // ========== CALENDAR FUNCTIONS ==========
        async function loadMonthBookings(year, month) {
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);
            
            const startStr = formatDateForInput(startDate);
            const endStr = formatDateForInput(endDate);
            
            const result = await callGAS('bookings', {
                startDate: startStr,
                endDate: endStr,
                showPast: 'true'
            }, { debounceKey: `month_${year}_${month}` });
            
            if (result.success) {
                state.dateBookings = {};
                if (result.data?.bookings) {
                    result.data.bookings.forEach(booking => {
                        const date = new Date(booking.startTime).toISOString().split('T')[0];
                        if (!state.dateBookings[date]) {
                            state.dateBookings[date] = [];
                        }
                        state.dateBookings[date].push(booking);
                    });
                }
                renderCalendar();
            }
        }

        function renderCalendar() {
            const year = state.currentMonth.getFullYear();
            const month = state.currentMonth.getMonth();
            
            $.currentMonth.textContent = formatMonthThai(state.currentMonth);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            let html = '';
            
            // Previous month days
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const date = new Date(year, month - 1, day);
                const dateStr = formatDateForInput(date);
                const hasBooking = state.dateBookings[dateStr]?.length > 0;
                const bookingCount = state.dateBookings[dateStr]?.length || 0;
                const isToday = isSameDay(date, new Date());
                
                html += renderCalendarDay(day, true, hasBooking, isToday, dateStr, bookingCount);
            }
            
            // Current month days
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateForInput(date);
                const bookings = state.dateBookings[dateStr] || [];
                const hasBooking = bookings.length > 0;
                const bookingCount = bookings.length;
                const isToday = isSameDay(date, new Date());
                const isSelected = isSameDay(date, state.selectedDate);
                
                html += renderCalendarDay(day, false, hasBooking, isToday, dateStr, bookingCount, isSelected);
            }
            
            // Next month days
            const totalCells = 42;
            const remainingCells = totalCells - (startDay + totalDays);
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dateStr = formatDateForInput(date);
                const hasBooking = state.dateBookings[dateStr]?.length > 0;
                const bookingCount = state.dateBookings[dateStr]?.length || 0;
                
                html += renderCalendarDay(day, true, hasBooking, false, dateStr, bookingCount);
            }
            
            $.calendarDays.innerHTML = html;
        }

        function renderCalendarDay(day, isOtherMonth, hasBooking, isToday, dateStr, bookingCount = 0, isSelected = false) {
            let classes = 'calendar-day';
            if (isOtherMonth) classes += ' other-month';
            if (isToday) classes += ' today';
            if (isSelected) classes += ' selected';
            if (hasBooking) {
                classes += ' has-booking';
                if (bookingCount > 1) {
                    classes += ' multiple';
                }
            }
            
            return `<div class="${classes}" onclick="selectDate('${dateStr}')">${day}</div>`;
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        window.selectDate = async function(dateStr) {
            state.selectedDate = new Date(dateStr);
            renderCalendar();
            
            const result = await callGAS('bookings', {
                date: dateStr,
                showPast: 'true'
            }, { debounceKey: `date_${dateStr}` });
            
            if (result.success && result.data?.bookings?.length > 0) {
                const bookings = result.data.bookings;
                const dateObj = new Date(dateStr);
                const dateThai = dateObj.toLocaleDateString('th-TH', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                $.selectedDateTitle.textContent = `📅 การจองวันที่ ${dateThai}`;
                $.selectedDateBookingsList.innerHTML = bookings.map(b => {
                    const statusClass = b.status === 'confirmed' ? '' : 'pending';
                    return `
                        <div class="date-booking-item ${statusClass}" onclick="showBookingDetail('${b.bookingId}')">
                            <div class="date-booking-time">
                                <i class="far fa-clock mr-1"></i> ${formatTime(b.startTime)} - ${formatTime(b.endTime)}
                            </div>
                            <div class="date-booking-title">${b.title}</div>
                            <div class="date-booking-room">${b.roomName} | โดย: ${b.userName}</div>
                        </div>
                    `;
                }).join('');
                
                $.selectedDateBookings.classList.remove('hidden');
            } else {
                $.selectedDateBookings.classList.add('hidden');
            }
        };

        window.changeMonth = function(delta) {
            const newMonth = new Date(state.currentMonth);
            newMonth.setMonth(newMonth.getMonth() + delta);
            state.currentMonth = newMonth;
            loadMonthBookings(newMonth.getFullYear(), newMonth.getMonth());
        };

        window.goToToday = function() {
            state.currentMonth = new Date();
            state.selectedDate = new Date();
            loadMonthBookings(state.currentMonth.getFullYear(), state.currentMonth.getMonth());
            selectDate(formatDateForInput(new Date()));
        };

        window.showAllRooms = function() {
            $.searchInput.value = '';
            renderRooms();
        };

        // ========== SETTINGS ==========
        async function loadSettings() {
            try {
                const result = await callGAS('admin/settings/get', {}, { debounceKey: 'settings' });
                
                if (result.success) {
                    state.settings = result.data || {
                        appName: 'Meeting Room',
                        requireApproval: 'true',
                        reminderMinutes: '30'
                    };
                    
                    document.getElementById('setting-app-name').value = state.settings.appName || 'Meeting Room';
                    
                    if ($.settingRequireApproval) {
                        const requireApproval = state.settings.requireApproval;
                        let isChecked = false;
                        
                        if (typeof requireApproval === 'string') {
                            isChecked = requireApproval.toLowerCase() === 'true' || requireApproval === '1';
                        } else if (typeof requireApproval === 'boolean') {
                            isChecked = requireApproval;
                        } else if (typeof requireApproval === 'number') {
                            isChecked = requireApproval === 1;
                        }
                        
                        $.settingRequireApproval.checked = isChecked;
                    }
                    
                    if ($.settingReminderMinutes) {
                        $.settingReminderMinutes.value = state.settings.reminderMinutes || '30';
                    }
                    
                    updateAppName(state.settings.appName);
                } else {
                    // ลองโหลดจาก endpoint เก่า
                    const fallbackResult = await callGAS('settings', {}, { debounceKey: 'settings_fallback' });
                    
                    if (fallbackResult.success) {
                        state.settings = fallbackResult.data || {
                            appName: 'Meeting Room',
                            requireApproval: 'true',
                            reminderMinutes: '30'
                        };
                        
                        document.getElementById('setting-app-name').value = state.settings.appName || 'Meeting Room';
                        
                        if ($.settingRequireApproval) {
                            const requireApproval = state.settings.requireApproval;
                            let isChecked = false;
                            
                            if (typeof requireApproval === 'string') {
                                isChecked = requireApproval.toLowerCase() === 'true' || requireApproval === '1';
                            } else if (typeof requireApproval === 'boolean') {
                                isChecked = requireApproval;
                            } else if (typeof requireApproval === 'number') {
                                isChecked = requireApproval === 1;
                            }
                            
                            $.settingRequireApproval.checked = isChecked;
                        }
                        
                        if ($.settingReminderMinutes) {
                            $.settingReminderMinutes.value = state.settings.reminderMinutes || '30';
                        }
                        
                        updateAppName(state.settings.appName);
                    }
                }
            } catch (error) {
                console.error('Load settings error:', error);
            }
        }

        window.saveSettings = async function(e) {
            e.preventDefault();
            
            const appName = document.getElementById('setting-app-name').value.trim() || 'Meeting Room';
            const requireApproval = $.settingRequireApproval ? $.settingRequireApproval.checked : true;
            const reminderMinutes = $.settingReminderMinutes?.value || '30';

            const saveBtn = $.settingsSaveBtn;
            setButtonLoading(saveBtn, true);

            const data = {
                appName,
                requireApproval: requireApproval ? 'true' : 'false',
                reminderMinutes,
                lineUserId: state.user.lineUserId
            };

            const result = await callGAS('admin/settings/update', data, { priority: 'high' });
            
            if (result.success) {
                showToast('บันทึกสำเร็จ');
                Object.assign(state.settings, data);
                updateAppName(appName);
            } else {
                showToast(result.message || 'บันทึกไม่สำเร็จ', 'error');
            }

            setButtonLoading(saveBtn, false);
        };

        window.resetDatabase = async function() {
            if (!state.isAdmin) {
                showToast('เฉพาะผู้ดูแลระบบเท่านั้น', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'รีเซ็ตฐานข้อมูล',
                text: 'คุณแน่ใจหรือไม่? ข้อมูลทั้งหมดจะถูกลบและกลับสู่ค่าเริ่มต้น',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ใช่, รีเซ็ต',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                const apiResult = await callGAS('reset-database', { confirm: 'RESET_ALL' }, { priority: 'high' });
                if (apiResult.success) {
                    showToast('รีเซ็ตฐานข้อมูลสำเร็จ');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(apiResult.message || 'เกิดข้อผิดพลาด', 'error');
                }
            }
        };

        // ========== PROFILE ==========
        window.showProfileSettings = function() {
            document.getElementById('profile-phone').value = state.user?.phone || '';
            document.getElementById('profile-department').value = state.user?.department || '';
            document.getElementById('profile-modal').classList.add('active');
        };

        window.closeProfileModal = function() {
            document.getElementById('profile-modal').classList.remove('active');
        };

        window.saveProfile = async function(e) {
            e.preventDefault();
            
            const saveBtn = e.submitter;
            setButtonLoading(saveBtn, true);

            const data = {
                phone: document.getElementById('profile-phone').value,
                department: document.getElementById('profile-department').value,
                lineUserId: state.user.lineUserId
            };

            const result = await callGAS('user/update', data, { priority: 'high' });
            if (result.success) {
                showToast('บันทึกสำเร็จ');
                Object.assign(state.user, data);
                closeProfileModal();
            } else {
                showToast(result.message || 'บันทึกไม่สำเร็จ', 'error');
            }

            setButtonLoading(saveBtn, false);
        };

        window.logout = function() {
            if (liff.isLoggedIn()) liff.logout();
            location.reload();
        };

        // ========== TAB SWITCHING ==========
        window.switchTab = function(tab) {
            $.navItems.forEach(i => i.classList.remove('active'));
            document.querySelectorAll(`[data-tab="${tab}"]`).forEach(i => i.classList.add('active'));
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            if (tab === 'my') loadMyBookings();
            if (tab === 'admin' && state.isManager) {
                loadAdminStats();
                loadUsers();
                loadPendingBookings();
                loadAllBookings();
                loadRoomsManagement();
            }
        };

        window.goHome = function() {
            switchTab('home');
        };

        // ========== EVENT LISTENERS ==========
        let searchTimer;
        if ($.searchInput) {
            $.searchInput.addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => {
                    renderRooms();
                }, 300);
            });
        }

        if ($.userSearch) {
            $.userSearch.addEventListener('input', renderUsers);
        }
        
        if ($.adminBookingSearch) {
            $.adminBookingSearch.addEventListener('input', renderAllBookings);
        }

        if ($.refreshAdmin) {
            $.refreshAdmin.addEventListener('click', () => {
                if (state.isManager) {
                    loadAdminStats();
                    loadUsers();
                    loadPendingBookings();
                    loadAllBookings();
                    loadRoomsManagement();
                }
            });
        }

        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
                document.getElementById(`admin-${btn.dataset.adminTab}-tab`).classList.remove('hidden');
                
                if (btn.dataset.adminTab === 'rooms') {
                    loadRoomsManagement();
                } else if (btn.dataset.adminTab === 'bookings') {
                    loadAllBookings();
                } else if (btn.dataset.adminTab === 'users') {
                    loadUsers();
                } else if (btn.dataset.adminTab === 'pending') {
                    loadPendingBookings();
                }
            });
        });

        document.querySelectorAll('[data-booking-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-booking-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderMyBookings(btn.dataset.bookingFilter);
            });
        });

        $.navItems.forEach(item => {
            item.addEventListener('click', () => {
                switchTab(item.dataset.tab);
            });
        });

        document.getElementById('profile-header')?.addEventListener('click', () => {
            Swal.fire({
                title: state.user?.displayName,
                text: state.user?.email,
                showCancelButton: true,
                confirmButtonText: 'แก้ไขโปรไฟล์',
                cancelButtonText: 'ออกจากระบบ'
            }).then(r => {
                if (r.isConfirmed) showProfileSettings();
                else if (r.dismiss === Swal.DismissReason.cancel) logout();
            });
        });

        document.getElementById('booking-room')?.addEventListener('change', checkAvailability);
        document.getElementById('booking-date')?.addEventListener('change', checkAvailability);
        document.getElementById('booking-end-date')?.addEventListener('change', checkAvailability);
        document.getElementById('booking-start')?.addEventListener('change', checkAvailability);
        document.getElementById('booking-end')?.addEventListener('change', checkAvailability);

        // ========== INIT ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLIFF);
        } else {
            initLIFF();
        }
    </script>
</body>
</html>
