<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meeting Room</title>
    
    <!-- LINE LIFF ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡∏î -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ CSS framework ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0a0a0f;
            color: #fff;
            padding-bottom: 70px;
        }

        /* Navbar ‡∏™‡πÑ‡∏ï‡∏•‡πå LINE */
        .nav {
            position: sticky;
            top: 0;
            background: #0a0a0f;
            border-bottom: 1px solid #2a2e36;
            padding: 12px 16px;
            z-index: 10;
        }

        .nav h1 {
            font-size: 20px;
            font-weight: 600;
            color: #06c755;
        }

        /* Profile card */
        .profile {
            background: #1a1d24;
            margin: 12px 16px;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid #2a2e36;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-img {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: #2a2e36;
            border: 2px solid #06c755;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 600;
            font-size: 16px;
        }

        .profile-role {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 8px;
            margin: 0 16px 16px;
        }

        .stat {
            flex: 1;
            background: #1a1d24;
            border: 1px solid #2a2e36;
            border-radius: 16px;
            padding: 12px 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #06c755;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 11px;
            color: #9ca3af;
        }

        /* Search */
        .search {
            margin: 0 16px 16px;
            position: relative;
        }

        .search input {
            width: 100%;
            padding: 12px 16px;
            background: #1a1d24;
            border: 1px solid #2a2e36;
            border-radius: 30px;
            color: #fff;
            font-size: 14px;
        }

        .search input:focus {
            outline: none;
            border-color: #06c755;
        }

        /* Rooms grid */
        .rooms {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 16px;
        }

        .room-card {
            background: #1a1d24;
            border: 1px solid #2a2e36;
            border-radius: 16px;
            overflow: hidden;
        }

        .room-image {
            height: 140px;
            background: #2a2e36;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .room-image i {
            font-size: 40px;
            color: #06c755;
        }

        .room-content {
            padding: 12px;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .room-name {
            font-weight: 600;
            font-size: 16px;
        }

        .room-capacity {
            background: rgba(6,199,85,0.1);
            color: #06c755;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
        }

        .room-location {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .room-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-status {
            color: #06c755;
            font-size: 13px;
        }

        .room-btn {
            background: none;
            border: none;
            color: #06c755;
            font-size: 14px;
            padding: 8px 12px;
        }

        /* Bottom nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1d24;
            border-top: 1px solid #2a2e36;
            display: flex;
            padding: 8px 0 12px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #9ca3af;
            font-size: 11px;
        }

        .nav-item.active {
            color: #06c755;
        }

        /* Loading */
        .skeleton {
            background: linear-gradient(90deg, #1a1d24 25%, #252930 50%, #1a1d24 75%);
            background-size: 200% 100%;
            animation: loading 1.2s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: none;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1d24;
            border-radius: 24px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid #2a2e36;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #06c755;
            margin-bottom: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background: #0a0a0f;
            border: 1px solid #2a2e36;
            border-radius: 12px;
            color: #fff;
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #06c755;
            color: #fff;
        }

        .modal-btn.secondary {
            background: #2a2e36;
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        .fa, .fas {
            display: inline-block;
        }
    </style>
    
    <!-- Font Awesome ‡πÅ‡∏ö‡∏ö async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
</head>
<body>
    <!-- Navbar -->
    <div class="nav">
        <h1 id="appName">Meeting Room</h1>
    </div>

    <!-- Profile Skeleton -->
    <div class="profile" id="profileSkeleton">
        <div class="profile-img skeleton"></div>
        <div class="profile-info">
            <div class="profile-name skeleton" style="height:16px;width:120px;"></div>
            <div class="profile-role skeleton" style="height:12px;width:80px;margin-top:8px;"></div>
        </div>
    </div>

    <!-- Profile Real (hidden) -->
    <div class="profile hidden" id="profileReal">
        <img class="profile-img" id="profileImg" src="" alt="">
        <div class="profile-info">
            <div class="profile-name" id="profileName"></div>
            <div class="profile-role" id="profileRole"></div>
        </div>
    </div>

    <!-- Stats Skeleton -->
    <div class="stats" id="statsSkeleton">
        <div class="stat skeleton" style="height:80px;"></div>
        <div class="stat skeleton" style="height:80px;"></div>
        <div class="stat skeleton" style="height:80px;"></div>
    </div>

    <!-- Stats Real (hidden) -->
    <div class="stats hidden" id="statsReal">
        <div class="stat">
            <div class="stat-value" id="statRooms">0</div>
            <div class="stat-label">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="statToday">0</div>
            <div class="stat-label">‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="statPending">0</div>
            <div class="stat-label">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
        </div>
    </div>

    <!-- Search -->
    <div class="search">
        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°...">
    </div>

    <!-- Rooms List -->
    <div class="rooms" id="roomsList">
        <div class="room-card skeleton" style="height:220px;"></div>
        <div class="room-card skeleton" style="height:220px;"></div>
        <div class="room-card skeleton" style="height:220px;"></div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-door-open"></i>
            <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </div>
        <div class="nav-item" data-tab="my">
            <i class="fas fa-calendar-check"></i>
            <span>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>
        </div>
        <div class="nav-item hidden" id="adminNav" data-tab="admin">
            <i class="fas fa-cog"></i>
            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div class="modal-title">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</div>
            <select class="modal-input" id="bookRoom">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            </select>
            <input type="text" class="modal-input" id="bookTitle" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°">
            <input type="date" class="modal-input" id="bookDate" value="">
            <div style="display:flex;gap:8px;">
                <input type="time" class="modal-input" id="bookStart" value="09:00" style="flex:1;">
                <input type="time" class="modal-input" id="bookEnd" value="10:00" style="flex:1;">
            </div>
            <input type="number" class="modal-input" id="bookAttendees" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°" value="4">
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="submitBooking()">‡∏à‡∏≠‡∏á</button>
                <button class="modal-btn secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Admin Room Modal -->
    <div class="modal" id="roomModal">
        <div class="modal-content">
            <div class="modal-title" id="roomModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>
            <input type="hidden" id="roomId">
            <input type="text" class="modal-input" id="roomName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á">
            <input type="number" class="modal-input" id="roomCapacity" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏">
            <input type="text" class="modal-input" id="roomLocation" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
            <textarea class="modal-input" id="roomDescription" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" rows="3"></textarea>
            <input type="text" class="modal-input" id="roomFacilities" placeholder="‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)">
            
            <!-- Upload image ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ -->
            <input type="file" class="modal-input" id="roomImage" accept="image/*">
            <div id="uploadStatus" style="font-size:12px;color:#9ca3af;margin-bottom:12px;"></div>
            
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="submitRoom()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="modal-btn secondary" onclick="closeRoomModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // ========== CONFIG ==========
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbwEkTSINEvnyBdapUWbJ8djVpdLt6rN7NlaXn5cKMow7RJtY3gI19-RSMyFHsWBxII-vA/exec';
            const LIFF_ID = '2008904120-nqYHD5BT';
            
            // ========== STATE ==========
            let user = null;
            let rooms = [];
            let myBookings = [];
            let isAdmin = false;
            
            // ========== DOM ==========
            const profileSkeleton = document.getElementById('profileSkeleton');
            const profileReal = document.getElementById('profileReal');
            const profileImg = document.getElementById('profileImg');
            const profileName = document.getElementById('profileName');
            const profileRole = document.getElementById('profileRole');
            
            const statsSkeleton = document.getElementById('statsSkeleton');
            const statsReal = document.getElementById('statsReal');
            const statRooms = document.getElementById('statRooms');
            const statToday = document.getElementById('statToday');
            const statPending = document.getElementById('statPending');
            
            const roomsList = document.getElementById('roomsList');
            const searchInput = document.getElementById('searchInput');
            const adminNav = document.getElementById('adminNav');
            
            // ========== API CALL ==========
            async function callGAS(path, data = {}) {
                const formData = new FormData();
                formData.append('path', path);
                
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        formData.append(key, data[key]);
                    }
                });

                try {
                    const res = await fetch(GAS_URL, { 
                        method: 'POST', 
                        body: formData
                    });
                    const text = await res.text();
                    return JSON.parse(text);
                } catch (e) {
                    console.error('API Error:', e);
                    return { success: false, message: 'Connection error' };
                }
            }

            // ========== INIT - ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ==========
            (async function init() {
                try {
                    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF
                    await liff.init({ liffId: LIFF_ID });
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }

                    // 2. ‡πÇ‡∏´‡∏•‡∏î profile ‡∏à‡∏≤‡∏Å LIFF (local)
                    const liffProfile = await liff.getProfile();
                    
                    // 3. ‡πÇ‡∏´‡∏•‡∏î rooms ‡∏à‡∏≤‡∏Å server (‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
                    const roomsRes = await callGAS('rooms');
                    if (roomsRes.success) {
                        rooms = roomsRes.data || [];
                        renderRooms(rooms);
                        statRooms.textContent = rooms.length;
                    }

                    // 4. ‡πÇ‡∏´‡∏•‡∏î user profile (‡∏≠‡∏≤‡∏à‡∏ä‡πâ‡∏≤)
                    const userRes = await callGAS('user/profile', {
                        lineUserId: liffProfile.userId,
                        displayName: liffProfile.displayName,
                        pictureUrl: liffProfile.pictureUrl || ''
                    });

                    if (userRes.success) {
                        user = userRes.data;
                        isAdmin = user.role === 'admin';
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï profile
                        profileImg.src = liffProfile.pictureUrl || 'https://via.placeholder.com/48/2a2e36/06c755?text=U';
                        profileName.textContent = liffProfile.displayName;
                        profileRole.textContent = {
                            admin: 'üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                            manager: 'üë• ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',
                            user: 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'
                        }[user.role] || '';
                        
                        // ‡πÅ‡∏™‡∏î‡∏á admin nav
                        if (isAdmin) adminNav.classList.remove('hidden');
                        
                        // ‡∏ã‡πà‡∏≠‡∏ô skeleton ‡πÅ‡∏™‡∏î‡∏á real
                        profileSkeleton.classList.add('hidden');
                        profileReal.classList.remove('hidden');
                        statsSkeleton.classList.add('hidden');
                        statsReal.classList.remove('hidden');
                        
                        // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                        const bookingsRes = await callGAS('user/bookings', { lineUserId: user.lineUserId });
                        if (bookingsRes.success) {
                            myBookings = bookingsRes.data || [];
                            
                            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                            const today = new Date().toISOString().split('T')[0];
                            const todayCount = myBookings.filter(b => 
                                b.startTime?.startsWith(today) && b.status === 'confirmed'
                            ).length;
                            const pendingCount = myBookings.filter(b => b.status === 'pending').length;
                            
                            statToday.textContent = todayCount;
                            statPending.textContent = pendingCount;
                        }
                    }

                } catch (err) {
                    console.error('Init error:', err);
                    // ‡∏ñ‡πâ‡∏≤ error ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á skeleton ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                }
            })();

            // ========== RENDER ROOMS ==========
            function renderRooms(roomsToRender) {
                const search = searchInput.value.toLowerCase();
                const filtered = roomsToRender.filter(r => 
                    r.name?.toLowerCase().includes(search) || 
                    r.location?.toLowerCase().includes(search)
                );

                if (filtered.length === 0) {
                    roomsList.innerHTML = '<div style="text-align:center;padding:40px;color:#9ca3af">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</div>';
                    return;
                }

                roomsList.innerHTML = filtered.map(room => `
                    <div class="room-card" onclick="showRoomDetail('${room.roomId}')">
                        <div class="room-image">
                            ${room.imageUrl ? 
                                `<img src="${room.imageUrl}" style="width:100%;height:100%;object-fit:cover;" loading="lazy">` : 
                                `<i class="fas fa-door-open"></i>`
                            }
                        </div>
                        <div class="room-content">
                            <div class="room-header">
                                <span class="room-name">${room.name}</span>
                                <span class="room-capacity"><i class="fas fa-users"></i> ${room.capacity}</span>
                            </div>
                            <div class="room-location">
                                <i class="fas fa-map-marker-alt"></i> ${room.location || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </div>
                            <div class="room-footer">
                                <span class="room-status"><i class="fas fa-check-circle"></i> ‡∏ß‡πà‡∏≤‡∏á</span>
                                <button class="room-btn" onclick="openBookingModal('${room.roomId}'); event.stopPropagation();">
                                    <i class="fas fa-calendar-plus"></i> ‡∏à‡∏≠‡∏á
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // ========== SEARCH ==========
            let searchTimer;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => renderRooms(rooms), 300);
            });

            // ========== BOOKING MODAL ==========
            window.openBookingModal = function(roomId = null) {
                const modal = document.getElementById('bookingModal');
                const roomSelect = document.getElementById('bookRoom');
                
                roomSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>' + 
                    rooms.map(r => `<option value="${r.roomId}" ${r.roomId === roomId ? 'selected' : ''}>${r.name}</option>`).join('');
                
                document.getElementById('bookDate').value = new Date().toISOString().split('T')[0];
                modal.classList.add('active');
            };

            window.submitBooking = async function() {
                if (!user) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                    return;
                }

                const roomId = document.getElementById('bookRoom').value;
                const title = document.getElementById('bookTitle').value;
                const date = document.getElementById('bookDate').value;
                const start = document.getElementById('bookStart').value;
                const end = document.getElementById('bookEnd').value;
                const attendees = document.getElementById('bookAttendees').value;

                if (!roomId || !title || !date || !start || !end) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                    return;
                }

                const startDateTime = new Date(`${date}T${start}:00`).toISOString();
                const endDateTime = new Date(`${date}T${end}:00`).toISOString();

                const res = await callGAS('booking/create', {
                    roomId,
                    title,
                    startTime: startDateTime,
                    endTime: endDateTime,
                    attendees,
                    userName: user.displayName,
                    lineUserId: user.lineUserId
                });

                if (res.success) {
                    alert('‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeModal();
                    
                    // reload stats
                    const bookingsRes = await callGAS('user/bookings', { lineUserId: user.lineUserId });
                    if (bookingsRes.success) {
                        myBookings = bookingsRes.data || [];
                        const today = new Date().toISOString().split('T')[0];
                        statToday.textContent = myBookings.filter(b => b.startTime?.startsWith(today) && b.status === 'confirmed').length;
                        statPending.textContent = myBookings.filter(b => b.status === 'pending').length;
                    }
                } else {
                    alert(res.message || '‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            };

            window.closeModal = function() {
                document.getElementById('bookingModal').classList.remove('active');
            };

            // ========== ROOM DETAIL ==========
            window.showRoomDetail = async function(roomId) {
                const room = rooms.find(r => r.roomId === roomId);
                if (!room) return;
                
                alert(`üìç ${room.location || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}\nüë• ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ${room.capacity} ‡∏Ñ‡∏ô\nüìù ${room.description || ''}\nüõ†Ô∏è ${room.facilities || ''}`);
            };

            // ========== ADMIN ROOM MODAL ==========
            window.openRoomModal = function(room = null) {
                const modal = document.getElementById('roomModal');
                document.getElementById('roomModalTitle').textContent = room ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('roomId').value = room?.roomId || '';
                document.getElementById('roomName').value = room?.name || '';
                document.getElementById('roomCapacity').value = room?.capacity || '';
                document.getElementById('roomLocation').value = room?.location || '';
                document.getElementById('roomDescription').value = room?.description || '';
                document.getElementById('roomFacilities').value = room?.facilities || '';
                document.getElementById('uploadStatus').textContent = '';
                modal.classList.add('active');
            };

            window.closeRoomModal = function() {
                document.getElementById('roomModal').classList.remove('active');
            };

            // ========== UPLOAD IMAGE ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ==========
            window.submitRoom = async function() {
                const roomId = document.getElementById('roomId').value;
                const name = document.getElementById('roomName').value;
                const capacity = document.getElementById('roomCapacity').value;
                const location = document.getElementById('roomLocation').value;
                const description = document.getElementById('roomDescription').value;
                const facilities = document.getElementById('roomFacilities').value;
                const imageFile = document.getElementById('roomImage').files[0];

                if (!name || !capacity || !location) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                    return;
                }

                document.getElementById('uploadStatus').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

                let imageUrl = '';
                
                // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('path', 'uploadImage');
                    formData.append('lineUserId', user.lineUserId);
                    
                    // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
                    const reader = new FileReader();
                    const base64Promise = new Promise((resolve) => {
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                    });
                    reader.readAsDataURL(imageFile);
                    
                    const base64 = await base64Promise;
                    
                    const uploadRes = await callGAS('uploadImage', {
                        fileName: imageFile.name,
                        fileData: base64,
                        mimeType: imageFile.type
                    });
                    
                    if (uploadRes.success) {
                        imageUrl = uploadRes.data.fileUrl;
                    } else {
                        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        document.getElementById('uploadStatus').textContent = '';
                        return;
                    }
                }

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡πâ‡∏≠‡∏á
                const res = await callGAS(roomId ? 'room/update' : 'room/create', {
                    roomId: roomId || undefined,
                    name,
                    capacity: parseInt(capacity),
                    location,
                    description,
                    facilities,
                    imageUrl,
                    lineUserId: user.lineUserId
                });

                if (res.success) {
                    alert(roomId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeRoomModal();
                    
                    // reload rooms
                    const roomsRes = await callGAS('rooms');
                    if (roomsRes.success) {
                        rooms = roomsRes.data || [];
                        renderRooms(rooms);
                        statRooms.textContent = rooms.length;
                    }
                } else {
                    alert(res.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
                
                document.getElementById('uploadStatus').textContent = '';
            };

            // ========== TAB SWITCHING ==========
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    const tab = item.dataset.tab;
                    if (tab === 'my' && user) {
                        showMyBookings();
                    } else if (tab === 'admin' && isAdmin) {
                        showAdminPanel();
                    }
                });
            });

            function showMyBookings() {
                if (myBookings.length === 0) {
                    alert('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
                    return;
                }
                
                const text = myBookings.map(b => {
                    const status = b.status === 'confirmed' ? '‚úÖ' : '‚è≥';
                    const date = new Date(b.startTime).toLocaleDateString('th-TH');
                    return `${status} ${b.roomName} ${date}`;
                }).join('\n');
                
                alert('üìÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n' + text);
            }

            function showAdminPanel() {
                const action = prompt('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π:\n1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á\n2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á\n3. ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á');
                
                if (action === '1') {
                    openRoomModal();
                } else if (action === '2') {
                    const roomNames = rooms.map(r => r.name).join('\n');
                    const name = prompt('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n' + roomNames);
                    const room = rooms.find(r => r.name === name);
                    if (room) openRoomModal(room);
                } else if (action === '3') {
                    const roomNames = rooms.map(r => r.name).join('\n');
                    const name = prompt('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö:\n' + roomNames);
                    const room = rooms.find(r => r.name === name);
                    if (room && confirm(`‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ${room.name}?`)) {
                        callGAS('room/delete', { roomId: room.roomId, lineUserId: user.lineUserId }).then(res => {
                            if (res.success) {
                                alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                                location.reload();
                            }
                        });
                    }
                }
            }

            // ========== GLOBAL FUNCTIONS ==========
            window.goHome = function() {
                document.querySelector('[data-tab="home"]').click();
            };
        })();
    </script>
</body>
</html>
